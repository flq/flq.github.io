{"data":{"markdownRemark":{"html":"<p>Fair enough, production code is unlikely to be running in a cute .NET Console App, but maybe you come into a situation where you at least want to prevent somebody from closing your console window without going through your lovely cleanup routines. This <a href=\"http://www.msnewsgroups.net/group/microsoft.public.dotnet.languages.csharp/topic10229.aspx\">link here</a> will tell you what you can do.</p>\n<p>To spread the word and to have a slightly less wordy version (using e.g. already defined delegates), you may also just look here (or in <a href=\"https://stackoverflow.com/a/474743/51428\">Stackoverflow</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token class-name\">DllImport</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Kernel32\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">extern</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">SetConsoleCtrlHandler</span><span class=\"token punctuation\">(</span>\n    Func<span class=\"token operator\">&lt;</span>CtrlType<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span><span class=\"token operator\">></span> handler<span class=\"token punctuation\">,</span> \n    <span class=\"token keyword\">bool</span> <span class=\"token keyword\">add</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">enum</span> CtrlType\n<span class=\"token punctuation\">{</span>\n    CTRL_C_EVENT <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    CTRL_BREAK_EVENT <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    CTRL_CLOSE_EVENT <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    CTRL_LOGOFF_EVENT <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    CTRL_SHUTDOWN_EVENT <span class=\"token operator\">=</span> <span class=\"token number\">6</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">Handler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CtrlType</span> sig<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sig <span class=\"token operator\">==</span> CtrlType<span class=\"token punctuation\">.</span>CTRL_CLOSE_EVENT<span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">//DoCleanup stuff here</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Some boilerplate to react to close window event</span>\n    <span class=\"token function\">SetConsoleCtrlHandler</span><span class=\"token punctuation\">(</span>Handler<span class=\"token punctuation\">,</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>\"Handler\" is just interested in the close event. It returns a boolean that states whether the given <em>Close</em>-message is handled. If you e.g. are letting your Console App hang around with <em>Console.ReadLine()</em> you better return that the event is not handled yet. That way, whatever routines are in place from .NET to handle the blocking <em>Console</em>-call will also be executed. If you would set handled = true, your App is essentially locked and Windows will ask you to end the process.</p>","fields":{"slug":"/2008/03/31/someone-closes-your-console-stopping-you-from-doing-any-cleanup"},"frontmatter":{"date":"March 31, 2008","path":null,"title":"Someone closes your console, stopping you from doing any cleanup?","tags":["dotnet"]}}},"pageContext":{"title":"Someone closes your console, stopping you from doing any cleanup?","previous":{"fields":{"slug":"/2008/03/30/poetry-i"},"frontmatter":{"title":"Poetry I","tags":["loosely-coupled"],"date":"2008/03/30"}},"next":{"fields":{"slug":"/2008/04/03/ndepend-cheat-sheet"},"frontmatter":{"title":"NDepend Cheat Sheet","tags":["download","dotnet","tools"],"date":"2008/04/03"}}}}