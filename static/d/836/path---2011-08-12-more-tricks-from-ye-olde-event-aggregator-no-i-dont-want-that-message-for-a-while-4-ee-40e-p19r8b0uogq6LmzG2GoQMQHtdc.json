{"data":{"markdownRemark":{"html":"<p>You may know by now that MemBus is my favorite Event Aggregator. This is because it allows you to mess quite a bit with the way publishing and subscription needs. Consider the following situation:</p>\n<p>An instance is accepting messages of a certain kind but wants to opt out of it from time to time. The easy way out would be to check some boolean in your message handle code. alas, handle implementors would have to think of not forgetting that – it leads to that ceremony code we have learned to despise.</p>\n<p>Check out the subscribing code:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">TheSubscriber</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">ICancelSpecials</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">bool</span> _isSuspended<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Suspend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>    <span class=\"token punctuation\">{</span>  _isSuspended <span class=\"token operator\">=</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">;</span>  <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>  _isSuspended <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span><span class=\"token punctuation\">;</span>  <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NormalMessage</span> msg<span class=\"token punctuation\">)</span>   <span class=\"token punctuation\">{</span>  <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpecialMessage</span> msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">bool</span> ICancelSpecials<span class=\"token punctuation\">.</span>IsSuspended\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">get</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> _isSuspended<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Note that ICancelSpecials is something from your application. What we want is that when the subsciber is “Suspended”, no more “special” messages are moved into the corresponding “Handle” method. In order to support this, we set up MemBus in the following way:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">_bus <span class=\"token operator\">=</span> BusSetup<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">StartWith</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Conservative</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Apply</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">FlexibleSubscribeAdapter</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">=</span><span class=\"token operator\">&amp;</span>gt<span class=\"token punctuation\">;</span> a<span class=\"token punctuation\">.</span><span class=\"token function\">ByMethodName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Handle\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Apply</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlockSpecialsIfsuspended</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">Construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <strong>BlockSpecialsIfSuspended</strong> is not a MemBus class, but provided by “us”. Let’s have a look at it:</p>\n<div style=\"padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px\" id=\"scid:812469c5-0cb0-4c63-8c15-c81123a09de7:58922d2c-8f18-4260-8f65-84e8600fe737\" class=\"wlWriterEditableSmartContent\"><pre name=\"code\" class=\"c#\">public class BlockSpecialsIfsuspended : ISetup&lt;IConfigurableBus&gt;\n{\n    public void Accept(IConfigurableBus setup)\n    {\n        setup.ConfigureSubscribing(SubscribeConfig);\n    }\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">private static void SubscribeConfig(IConfigurableSubscribing cs)\n{\n    cs.MessageMatch(mi =&amp;gt; mi.Name.StartsWith(&quot;Special&quot;), ConfigureSpecial);\n}\n\nprivate static void ConfigureSpecial(IConfigureSubscription cs)\n{\n    cs.ShapeOutwards(new DenyIfSuspended(), new ShapeToDispose());\n}</code></pre></div>\n<p>}</pre></div></p>\n<p>What this class does it accessing the configuration part regarding subscribing. Based on a MessageMatch, essentially a filter to state for which messages you want to influence the way subscriptions are treated. Here we specify the <a href=\"http://realfiction.net/go/181\">ISubscriptionShape</a> instances that will be applied to the basic subscription inside out. Hence, <strong>DenyIfSuspended</strong> is an <strong>ISubscriptionShape</strong> implementation:</p>\n<div style=\"padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px\" id=\"scid:812469c5-0cb0-4c63-8c15-c81123a09de7:c36de501-2108-486e-b710-88af2b41abf0\" class=\"wlWriterEditableSmartContent\"><pre name=\"code\" class=\"c#\">private class DenyIfSuspended : ISubscriptionShaper, ISubscription\n{\n    private readonly ISubscription _inner;\n    private readonly ICancelSpecials _cancelSpecials;\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public DenyIfSuspended() { }\n\nprivate DenyIfSuspended(ISubscription inner, ICancelSpecials cancelSpecials)\n{\n    _inner = inner;\n    _cancelSpecials = cancelSpecials;\n}\n\nISubscription ISubscriptionShaper.EnhanceSubscription(ISubscription subscription)\n{\n    var theCancelSpecials = (subscription as IKnowsSubscribedInstance).IfNotNull(ks =&amp;gt; ks.Instance as ICancelSpecials);\n    return theCancelSpecials != null ? new DenyIfSuspended(subscription, theCancelSpecials) : subscription;\n}\n\nvoid ISubscription.Push(object message)\n{\n    if (!_cancelSpecials.IsSuspended)\n        _inner.Push(message);\n}\n\nbool ISubscription.Handles(Type messageType)\n{\n    return _inner.Handles(messageType);\n}</code></pre></div>\n<p>}</pre></div></p>\n<p>This class plays the role of shaping a subscription as well as being a subscription. If it can figure out that the subsription it is looking at knows the instance providing (<strong>IKnowsSubscribedInstance</strong>) the subscription and if that instance implements ICancelSpecials, then it will return itself as subscription, otherwise it will do nothing.</p>\n<p>Being a subscription, it will only push the message downwards if the instance is not suspended.</p>\n<p>In the end, you may say that this involves a bit of ceremony as well – bear in mind, though, that this is done once, and applies to that particular situation in your application. You can e.g. implement ICancelSpecials in a base class, and have your handle methods in the specializations</p>","frontmatter":{"date":"August 12, 2011","path":null,"title":"More tricks from ye olde Event Aggregator: No, I don’t want that message for a while","tags":["software-development","membus"]}}},"pageContext":{"title":"More tricks from ye olde Event Aggregator: No, I don’t want that message for a while","previous":{"fields":{"slug":"/2011/05/07/using-fubumvc-day1"},"frontmatter":{"title":"Using FubuMVC - Day1","tags":["software-development","dotnet","web","libs-and-frameworks"],"date":"2011/05/07"}},"next":{"fields":{"slug":"/2011/09/19/making-a-winrt-component-out-of-membus-–-pt-1-making-membus-compile"},"frontmatter":{"title":"Making a WinRT component out of Membus – Pt.1, making Membus compile","tags":["software-development","dotnet","membus","libs-and-frameworks"],"date":"2011/09/19"}}}}