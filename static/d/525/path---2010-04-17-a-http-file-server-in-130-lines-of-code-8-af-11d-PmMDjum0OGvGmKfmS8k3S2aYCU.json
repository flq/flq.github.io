{"data":{"markdownRemark":{"html":"<p>...of which 20 deal with mapping file extensions to MIME types. </p>\n<p>For an integration test I want to be able to set up an HTTP server that serves files from a directory. While I was at it I ensured that a proper directory listing and links are provided by the web server so I can browse the contents of a directory from my browser. With the aid of the <a href=\"http://msdn.microsoft.com/en-us/library/system.net.httplistener.aspx\">HttpListener</a> this is quite easy to do.</p>\n<p>The whole thing is wrapped inside a class HttpFileServer, implementing disposable.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token function\">HttpFileServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span> rootPath<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>rootPath <span class=\"token operator\">=</span> rootPath<span class=\"token punctuation\">;</span>\n  http <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  http<span class=\"token punctuation\">.</span>Prefixes<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8889/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  http<span class=\"token punctuation\">.</span><span class=\"token function\">Start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  http<span class=\"token punctuation\">.</span><span class=\"token function\">BeginGetContext</span><span class=\"token punctuation\">(</span>requestWait<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  http<span class=\"token punctuation\">.</span><span class=\"token function\">Stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Careful with the selection of your port. You’ll get an Exception if it is registered to another application, even if that application is not running. The <em>requestWait</em> method is a callback that allows you to react to incoming requests asynchronously. It should be implemented with the well known pattern introduced to .NEt almost a decade ago:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>http<span class=\"token punctuation\">.</span>IsListening<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> c <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">EndGetContext</span><span class=\"token punctuation\">(</span>ar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nhttp<span class=\"token punctuation\">.</span><span class=\"token function\">BeginGetContext</span><span class=\"token punctuation\">(</span>requestWait<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>c is of type <a href=\"http://msdn.microsoft.com/en-us/library/system.net.httplistenercontext.aspx\">HttpListenerContext</a>. The callback will also be called when the HttpListener is stopped, hence make sure that you only do stuff when you really seem to have a legitimate request.</p>\n<p>As long as you keep your method re-entrant (i.e. you do not try to keep any request-specific state in some instance variable) you should be fine with multiple requests leading to multiple threads handling those.</p>\n<p>As a file server, I only need to differ between a file being requested, a directory or something I don’t know:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token function\">tuneUrl</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">.</span>RawUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> fullPath <span class=\"token operator\">=</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">IsNullOrEmpty</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> rootPath <span class=\"token punctuation\">:</span> Path<span class=\"token punctuation\">.</span><span class=\"token function\">Combine</span><span class=\"token punctuation\">(</span>rootPath<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Directory<span class=\"token punctuation\">.</span><span class=\"token function\">Exists</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">returnDirContents</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>File<span class=\"token punctuation\">.</span><span class=\"token function\">Exists</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">returnFile</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">else</span> \n  <span class=\"token function\">return404</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The dir contents just serves some HTML. Here, especially on a computer where German umlauts are inside directory and file names, you should not forget to put the proper encoding into the HTML header:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">context<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>ContentType <span class=\"token operator\">=</span> <span class=\"token string\">\"text/html\"</span><span class=\"token punctuation\">;</span>\ncontext<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>ContentEncoding <span class=\"token operator\">=</span> Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> sw <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StreamWriter</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>OutputStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  sw<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;html>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sw<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;head>&lt;meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=utf-8\\\">&lt;/head>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  sw<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;body>&lt;ul>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When links contain spaces, umlauts etc. modern browsers should take care about escaping them correctly into a URL request sent to the server (at least Chrome does). On the server side you need to ensure that this is converted back into things understood by the classes in System.IO, which happily deal with UTF-8 encoded strings. Thankfully there is a class in .NET, the <a href=\"http://msdn.microsoft.com/en-us/library/system.web.httputility.aspx\">HttpUtility</a> in System.Web that will be able to do that for you:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">string</span> <span class=\"token function\">tuneUrl</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span> url<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">Replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  url <span class=\"token operator\">=</span> HttpUtility<span class=\"token punctuation\">.</span><span class=\"token function\">UrlDecode</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  url <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">Substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> url<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>When actually hitting a file, you need to read it and write it to the appropriate output stream. Just to be on the safe side regarding file size, I chose a chunked approach:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">context<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>ContentType <span class=\"token operator\">=</span> \n  <span class=\"token function\">getcontentType</span><span class=\"token punctuation\">(</span>Path<span class=\"token punctuation\">.</span><span class=\"token function\">GetExtension</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span><span class=\"token function\">OpenRead</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  context<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>ContentLength64 <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> read<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>read <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span>gt<span class=\"token punctuation\">;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    context<span class=\"token punctuation\">.</span>Response<span class=\"token punctuation\">.</span>OutputStream<span class=\"token punctuation\">.</span><span class=\"token function\">Write</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Don’t forget in all cases to <strong>close the Output Stream</strong>. In the case of using a StreamWriter, it’s disposal will close the underlying stream, in the case of serving the file directly, you’ll need to do it yourself.</p>\n<p>To make things a bit more comfortable for e.g. a browser, it is useful to provide an appropriate MIME type. This is pretty boring code and goes along the lines of this example. A fairly nice list <a href=\"http://www.feedforall.com/mime-types.htm\">can be found here</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">string</span> <span class=\"token function\">getcontentType</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span> extension<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>extension<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\".avi\"</span><span class=\"token punctuation\">:</span>  <span class=\"token keyword\">return</span> <span class=\"token string\">\"video/x-msvideo\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">\".css\"</span><span class=\"token punctuation\">:</span>  <span class=\"token keyword\">return</span> <span class=\"token string\">\"text/css\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>And for those who want to play with this, here’s the full monty:</p>\n<script src=\"http://gist.github.com/369432.js?file=HttpFileServer.cs\"></script>[![Shout it](http://dotnetshoutout.com/image.axd?url=http%3A%2F%2Frealfiction.net%2Fgo%2F166)](http://dotnetshoutout.com/A-HTTP-file-server-in-130-lines-of-code)","frontmatter":{"date":"April 17, 2010","path":null,"title":"A HTTP file server in 130 lines of code","tags":["software-development","dotnet","web"]}}},"pageContext":{"title":"A HTTP file server in 130 lines of code","previous":{"fields":{"slug":"/2010/03/23/some-powershell-foo-playin-with-da-task-scheduler"},"frontmatter":{"title":"Some PowerShell Foo...playin' with da Task Scheduler","tags":["tools"],"date":"2010/03/23"}},"next":{"fields":{"slug":"/2010/05/08/visual-studio-2010-introducing-new-pitfalls"},"frontmatter":{"title":"Visual Studio 2010: Introducing new pitfalls","tags":["software-development","dotnet","tools"],"date":"2010/05/07"}}}}