{"data":{"markdownRemark":{"html":"<h2>2D Historization series</h2>\n<ol>\n<li><a href=\"/2016/12/18/2d-or-bitemporal-historization-a-primer\">2D or bitemporal Historization: A primer</a></li>\n<li><a href=\"/2017/01/26/2d-historization-in-a-graph-database\">2D-Historization in a graph database</a></li>\n<li>Simplify the bitemporal Neo4J query with a user-defined function</li>\n</ol>\n<p>In the previous post we have seen how we can translate the logic of\ncorrectly describing the historical events from the first post into a Cypher query.</p>\n<p>To remind you, it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">MATCH (pd:PersonData)-[r]-(p) \nWHERE p.id = 665544 AND r.recorded &lt;= 30\nWITH { data: pd, recorded: r.recorded, actual: r.actual } as data\nWITH data ORDER BY data.recorded DESC\nWITH reduce(relevant = [], d in collect(data) | \nCASE \nWHEN last(relevant) IS NULL OR d.actual &lt; last(relevant).actual THEN relevant+d \nELSE relevant END) \nAS data\nUNWIND data AS final \nRETURN final.actual, final.data</code></pre></div>\n<p>It is certainly a bit unwieldy, considering that you want historical data\nmaybe not only from a single node, but other ones, too.\nA good idea seems to be to let the query writer pick out those nodes that require\nconsideration and then have a function that contains the logic of picking up\nthe correct ones. Let us do just that.</p>\n<p>In Neo4J you can also <a href=\"http://neo4j.com/docs/developer-manual/current/extending-neo4j/procedures/\">write \"stored procedures\"</a> and \"user-defined functions\" (<strong>UDF</strong>).\nDepending on your upbringing you may dislike the idea of putting \"logic\" into the\ndatabase engine. However, there are two differences to stored procedures and functions\nas we know them from Oracle and Sql server:</p>\n<ul>\n<li>We can write the Neo4J code to be run as procedure / function in Java\n(or some other JVM language). Depending on how you write the other parts\nof your application this may considerably help in traslating your skills to the\nDB.</li>\n<li>Neo4J <a href=\"http://neo4j.com/docs/developer-manual/current/extending-neo4j/procedures/#_writing_integration_tests\">provides infrastructure</a> that allows you to fire up an embedded instance\nand use it within your tests to actually <strong>test your procedures / functions</strong>\nclose to real-life scenarios.</li>\n</ul>\n<p>With that in mind you may feel that not much speaks against encapsulating some\ntechnical aspect of your DB model into a function.</p>\n<p>The implementation of the UDF is pretty straightforward:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>neo4j<span class=\"token punctuation\">.</span>graphdb<span class=\"token punctuation\">.</span>GraphDatabaseService<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>neo4j<span class=\"token punctuation\">.</span>procedure<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>neo4j<span class=\"token punctuation\">.</span>procedure<span class=\"token punctuation\">.</span>UserFunction<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Bitemp</span>\n<span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@Context</span>\n  <span class=\"token keyword\">public</span> GraphDatabaseService db<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/**\n    * Creates a bitemporal projection for a list of maps\n    * @param data a list of maps of the form { data: node, recorded: int, actual: int }\n    * @return The stream of resulting paths throughout the object.\n    */</span>\n  <span class=\"token annotation punctuation\">@UserFunction</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bitemp.projection\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">public</span> List<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Map<span class=\"token punctuation\">></span></span> <span class=\"token function\">bitempProjection</span><span class=\"token punctuation\">(</span>\n          <span class=\"token annotation punctuation\">@Name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">)</span> List<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Map<span class=\"token punctuation\">></span></span> data<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n\n      List<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Map<span class=\"token punctuation\">></span></span> sorted <span class=\"token operator\">=</span> StreamSupport<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">spliterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>o1<span class=\"token punctuation\">,</span> o2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>Long<span class=\"token punctuation\">)</span> o2<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recorded\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>Long<span class=\"token punctuation\">)</span> o1<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recorded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>Collectors<span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      ArrayList<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Map<span class=\"token punctuation\">></span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Map n <span class=\"token operator\">:</span> sorted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">{</span>\n              result<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n          Map reference <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>n<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"actual\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>reference<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"actual\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n              result<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Of note is the  <code class=\"language-text\">UserFunction</code>-annotation, which did not exist until recent\nversions of Neo4J.\nBefore you had to define your user procedures as, well, procedures, making the\ncall of your procedures from within Cypher a little bit more involved (<code class=\"language-text\">CALL...YIELD</code>).</p>\n<p>Also remember that all numbers defined on nodes / relationships will appear as\n<strong>Long</strong>s.</p>\n<p>Finally, there is a <code class=\"language-text\">sort</code>-method on the <code class=\"language-text\">List</code>-interface, however, the implementation\nthat Neo4J passes to you appears to not implement it, hence the external sort\nvia the <code class=\"language-text\">Stream</code>-utilities.</p>\n<p>The function assumes that you send in data of a certain shape. It will then\nbe able to sort the nodes correctly and dismiss those nodes that are \"invisible\"\nwithin the given set.</p>\n<p>By compiling our UDF and adding the resulting jar to Neo4J's <strong>plugins</strong> folder,\nwe can start using it:</p>\n<div class=\"gatsby-highlight\" data-language=\"cypher\"><pre class=\"language-cypher\"><code class=\"language-cypher\">MATCH (pd:PersonData)-[r]-(p) \nWHERE p.id = 665544 AND r.recorded &lt;= 30\nWITH collect({ data: pd, recorded: r.recorded, actual: r.actual }) AS data\nUNWIND bitemp.projection(data) AS final\nRETURN final.actual, final.data</code></pre></div>\n<p>As you can see we have a nice distribution of responsibilities:\nQuery the correct set of data you are interested in, and use the function\nto project them correctly.</p>\n<p>For completeness' sake we can also provide a function that gives us the current\nstate for some query:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">/**\n  * Returns the current state out of a list of maps\n  * @param data a list of maps of the form { data: node, recorded: int, actual: int }\n  * @return The Map that is currently valid or none if nothing is valid right now.\n  */</span>\n<span class=\"token annotation punctuation\">@UserFunction</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bitemp.current\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> Map <span class=\"token function\">bitempCurrent</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Name</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">)</span> List<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Map<span class=\"token punctuation\">></span></span> data<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">long</span> today <span class=\"token operator\">=</span> <span class=\"token function\">getTodaysActual</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> StreamSupport<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token function\">bitempProjection</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">spliterator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span><span class=\"token operator\">></span>  <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>n<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"actual\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> today<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">long</span> <span class=\"token function\">getTodaysActual</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Node n <span class=\"token operator\">=</span> db<span class=\"token punctuation\">.</span><span class=\"token function\">findNodes</span><span class=\"token punctuation\">(</span>Label<span class=\"token punctuation\">.</span><span class=\"token function\">label</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Today\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>Long<span class=\"token punctuation\">)</span>n<span class=\"token punctuation\">.</span><span class=\"token function\">getProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This function uses the previously established UDF as well as a node labelled\n<strong>\"Today\"</strong> which should contain the numeric value of today (this can obviously\nbe solved differently, typically by using something like Epoch in seconds).\nSince the data already comes out newest to oldest from the <code class=\"language-text\">bitempProjection</code>-\nmethod, we can just pick the first item where the actual date is smaller than\ntoday.</p>\n<p>With that we can get the current state of our person:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">MATCH (pd:PersonData)-[r]-(p {id: 665544})\nWITH p, collect({ data: pd, recorded: r.recorded, actual: r.actual }) as data\nRETURN p, bitemp.current(data).data</code></pre></div>\n<p><img src=\"/assets/2DHistory6.png\"></p>","frontmatter":{"date":"January 30, 2017","path":null,"title":"Simplify the bitemporal Neo4J query with a user-defined function","tags":["software-development","patterns","programming"]}}},"pageContext":{"title":"Simplify the bitemporal Neo4J query with a user-defined function","previous":{"fields":{"slug":"/2017/01/27/2d-historization-in-a-graph-database"},"frontmatter":{"title":"2D-Historization in a graph database","tags":["software-development","patterns","programming","neo4j"],"date":"2017/01/27"}},"next":{"fields":{"slug":"/2017/03/08/wls-at-home-writeup"},"frontmatter":{"title":"WLS at home writeup","tags":["loosely-coupled"],"date":"2017/03/08"}}}}