{"data":{"markdownRemark":{"html":"<h3>Functional space-invaders series</h3>\n<ol>\n<li><a href=\"/2013/09/17/funspins-a-recap-of-rob-ashtons-lessons-das-intro\">A recap of Rob Ashton's lessons - Das Intro</a></li>\n<li><a href=\"/2013/09/18/funspins-drawing-a-rectangle\">Drawing a Rectangle</a></li>\n<li><a href=\"/2013/09/19/funspins-moving-a-rectangle\">Moving a Rectangle</a></li>\n<li><a href=\"/2013/09/20/funspins-no-attributes-no-vectors-a-tiny-workflow-and-more-squares\">No attributes, No vectors, A tiny Workflow and more squares</a></li>\n<li>State, the World, the Loop</li>\n<li><a href=\"/2013/09/24/funspins-the-hero-must-move-the-enemies-must-move-smarter\">The hero must move, the enemies must move smarter</a></li>\n<li><a href=\"/2013/09/25/funspins-the-hero-shoots\">The hero shoots</a></li>\n<li><a href=\"/2013/09/26/funspins-collisions-the-dead-and-a-not-so-grateful-ending\">Collisions, the dead, and a (not so) grateful ending</a></li>\n</ol>\n<blockquote>\n<p>Inspired by Rob Ashton's series \"<a href=\"http://codeofrob.com/entries/learn-functional-programming-with-me---mutating-lots-of-state.html\">Learn functional</a> <a href=\"http://codeofrob.com/entries/learn-functional-programming-with-me---improving-our-data-structure-with-maps.html\">programming with me</a>\"</p>\n</blockquote>\n<p>Recreating this episode <em>really</em> had me on the brink of giving up the whole thing. I am not a games programmer, <strong>FFS</strong>, what am I <em>doing</em> here?</p>\n<p>When it comes to things that look mildly imperative or indeed involve mutating state, Haskell keeps doing my head in. Of course Haskell has no troubles with state and its tendency to change, but while other languages have state baked in, in Haskell it is pretty much just another abstraction.</p>\n<p>So, I was searching for the right solution, and <a href=\"https://github.com/snkkid/LazyFooHaskell/tree/master/lesson20\">looked at timers</a>, based on <a href=\"http://lazyfoo.net/SDL_tutorials/\">Lazy Foo tutorials on SDL</a>. I looked at how to do <a href=\"http://random.axman6.com/blog/?p=231\">Co-routines in Haskell</a>, as I thought that this could be an interesting approach to having, well, coroutines spit out logic that gets rendered. This <a href=\"http://jshaskell.blogspot.de/2012/09/breakout.html\">surely is possible</a>, but right now, the level of abstraction really explodes my current time budget.</p>\n<p>To my relief, I did manage to construct a loop that would produce moving rectangles and should allow more interesting things later on. For this, we have the definition of a World:</p>\n<h3>The world</h3>\n<div class=\"gatsby-highlight\" data-language=\"haskell\"><pre class=\"language-haskell\"><code class=\"language-haskell\"><span class=\"token keyword\">data</span> <span class=\"token constant\">World</span> <span class=\"token operator\">=</span> <span class=\"token constant\">World</span> \n\t<span class=\"token punctuation\">{</span>\n\t\t<span class=\"token hvariable\">canvas</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Surface</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token hvariable\">lastEvent</span> <span class=\"token operator\">::</span> <span class=\"token constant\">Event</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token hvariable\">enemyGridOrigin</span> <span class=\"token operator\">::</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">Int</span><span class=\"token punctuation\">,</span><span class=\"token constant\">Int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token hvariable\">actors</span> <span class=\"token operator\">::</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">World</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">World</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token constant\">Rect</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token hvariable\">initWorld</span> <span class=\"token hvariable\">canvas</span> <span class=\"token operator\">=</span> <span class=\"token constant\">World</span> \n\t<span class=\"token punctuation\">{</span> \n\t\t<span class=\"token hvariable\">enemyGridOrigin</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token hvariable\">lastEvent</span> <span class=\"token operator\">=</span> <span class=\"token constant\">NoEvent</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token hvariable\">canvas</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">canvas</span><span class=\"token punctuation\">,</span> \n\t\t<span class=\"token hvariable\">actors</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token hvariable\">moveEnemyGrid</span><span class=\"token punctuation\">]</span> \n\t<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This object will play the role of keeping the state of our subsequent loops, as well as hosting what I have called <em>actors</em>. These guys must accept the World as input and return the World alongside a number of Rects. Returning the world allows to actually change it within the implementation of an actor</p>\n<h3>Records</h3>\n<p>A few words to Haskell's record-style syntax are probably in order right now. initWorld shows you how to create such a record. You can</p>\n<ul>\n<li>read out values as if the items of the record are functions and their parameter the record type. (e.g. <em>canvas world</em> would return the Surface stored within)</li>\n<li>match on the record type in a function declaration, thereby extracting value from it, e.g. foo (<em>World { canvas = c } --binds the canvas value to c</em>)</li>\n<li>replace one or more values of a record, example just follows...</li>\n</ul>\n<h3>The enemies</h3>\n<p>Our enemy grid function now looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"haskell\"><pre class=\"language-haskell\"><code class=\"language-haskell\">\t<span class=\"token hvariable\">moveEnemyGrid</span> <span class=\"token operator\">::</span> <span class=\"token constant\">World</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">World</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token constant\">Rect</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token hvariable\">moveEnemyGrid</span> <span class=\"token hvariable\">w</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">newState</span> <span class=\"token hvariable\">w</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">enemies</span><span class=\"token punctuation\">)</span>\n\t  <span class=\"token keyword\">where</span>\n\t    <span class=\"token hvariable\">newState</span> <span class=\"token hvariable\">w</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">w</span> <span class=\"token punctuation\">{</span> <span class=\"token hvariable\">enemyGridOrigin</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">newOrigin</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">enemyGridOrigin</span> <span class=\"token hvariable\">w</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\t    <span class=\"token hvariable\">newOrigin</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">x</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">y</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">x</span><span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">y</span><span class=\"token punctuation\">)</span>\n\t    <span class=\"token hvariable\">enemies</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">enemyGrid</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">enemyGridOrigin</span> <span class=\"token hvariable\">w</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\t    <span class=\"token hvariable\">enemyGrid</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">originX</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">originY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">rows</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">cols</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> \n\t      <span class=\"token builtin\">map</span> <span class=\"token hvariable\">enemy</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">x</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">y</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token hvariable\">x</span> <span class=\"token operator\">&lt;-</span> <span class=\"token builtin\">take</span> <span class=\"token hvariable\">cols</span> <span class=\"token punctuation\">[</span><span class=\"token hvariable\">originX</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">originX</span><span class=\"token operator\">+</span><span class=\"token number\">60</span><span class=\"token operator\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">y</span> <span class=\"token operator\">&lt;-</span> <span class=\"token builtin\">take</span> <span class=\"token hvariable\">rows</span> <span class=\"token punctuation\">[</span><span class=\"token hvariable\">originY</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">originY</span><span class=\"token operator\">+</span><span class=\"token number\">30</span><span class=\"token operator\">..</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n\t    <span class=\"token hvariable\">enemy</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">x</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">y</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token constant\">Rect</span> <span class=\"token hvariable\">x</span> <span class=\"token hvariable\">y</span> <span class=\"token number\">20</span> <span class=\"token number\">10</span></code></pre></div>\n<p>You may see that so far this is pretty much just a proof of concept. We change the enemy origin's x-value by 5 and otherwise output\nthe enemies as we already did in the previous post.</p>\n<p>Line 4 shows how we can replace a single value of our world-record. It looks a bit unwieldy, but truth be spoken records don't seem to be Haskell's strongest suit.\nThe signature of <em>moveEnemyGrid</em> is very characteristic of a method that mutates something - indeed, anything that should be different after a function has run must be returned by that function.</p>\n<p>Let us have a look at the loop...</p>\n<div class=\"gatsby-highlight\" data-language=\"haskell\"><pre class=\"language-haskell\"><code class=\"language-haskell\">\t<span class=\"token hvariable\">loop</span> <span class=\"token hvariable\">world</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">do</span>\n\t  <span class=\"token hvariable\">event</span> <span class=\"token operator\">&lt;-</span> <span class=\"token hvariable\">FX.pollEvent</span>\n\t  <span class=\"token hvariable\">FX.fillRect</span> <span class=\"token hvariable\">c</span> <span class=\"token constant\">Nothing</span> <span class=\"token hvariable\">black</span>\n\t  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">newWorld</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">rects</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">foldl</span> <span class=\"token hvariable\">runActor</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">world</span> <span class=\"token punctuation\">{</span> <span class=\"token hvariable\">lastEvent</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">event</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">$</span> <span class=\"token hvariable\">actors</span> <span class=\"token hvariable\">world</span>\n\t  <span class=\"token builtin\">mapM</span> <span class=\"token hvariable\">paint</span> <span class=\"token hvariable\">rects</span>\n\t  <span class=\"token constant\">FX</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">flip</span> <span class=\"token hvariable\">c</span>\n\t  <span class=\"token hvariable\">FX.delay</span> <span class=\"token number\">50</span>\n\t  <span class=\"token hvariable\">loop</span> <span class=\"token hvariable\">newWorld</span>\n\t  <span class=\"token keyword\">where</span>\n\t    <span class=\"token hvariable\">c</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">canvas</span> <span class=\"token hvariable\">world</span>\n\t    <span class=\"token hvariable\">paint</span> <span class=\"token hvariable\">r</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">do</span>\n\t      <span class=\"token hvariable\">FX.fillRect</span> <span class=\"token hvariable\">c</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">Just</span> <span class=\"token hvariable\">r</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">white</span>\n\t    <span class=\"token hvariable\">runActor</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">wld</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">rects</span><span class=\"token punctuation\">)</span> <span class=\"token hvariable\">actor</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">newWorld</span><span class=\"token punctuation\">,</span> <span class=\"token hvariable\">rects</span><span class=\"token operator\">++</span><span class=\"token hvariable\">moreRects</span><span class=\"token punctuation\">)</span>\n\t      <span class=\"token keyword\">where</span> <span class=\"token punctuation\">(</span><span class=\"token hvariable\">newWorld</span><span class=\"token punctuation\">,</span><span class=\"token hvariable\">moreRects</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token hvariable\">actor</span> <span class=\"token hvariable\">wld</span></code></pre></div>\n<p>The interaction with our World happens in line 4, everything else is render implementation details. What happens is that the list of actors is folded by successively passing in the World and giving the potentially mutated world to the next actor, meanwhile collecting all Rectangles from the actors that should be drawn to the canvas. At the end of the run we call <em>loop</em> again with the new world.</p>","fields":{"slug":"/2013/09/23/funspins-state-the-world-the-loop"},"frontmatter":{"date":"September 23, 2013","path":null,"title":"FunSpIns - State, the World, the Loop","tags":["programming","haskell","fun-spin"]}}},"pageContext":{"title":"FunSpIns - State, the World, the Loop","previous":{"fields":{"slug":"/2013/09/20/funspins-no-attributes-no-vectors-a-tiny-workflow-and-more-squares","published":true},"frontmatter":{"title":"FunSpIns - No attributes, No vectors, A tiny Workflow and more squares","tags":["programming","haskell","fun-spin"],"date":"2013/09/20"}},"next":{"fields":{"slug":"/2013/09/24/funspins-the-hero-must-move-the-enemies-must-move-smarter","published":true},"frontmatter":{"title":"FunSpIns - The hero must move, the enemies must move smarter.","tags":["programming","haskell","fun-spin"],"date":"2013/09/24"}}}}