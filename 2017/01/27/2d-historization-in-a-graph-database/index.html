<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.7d72528b3ac66ed04d14.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{position:relative;margin:.5em 0;overflow:visible;padding:0}pre[class*=language-]>code{position:relative;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-size:3em 3em;background-origin:content-box;background-attachment:local}code[class*=language]{max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{position:relative;padding:.2em;border-radius:.3em;color:#c92c2c;border:1px solid rgba(0,0,0,.1);display:inline;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{content:"";z-index:-2;display:block;position:absolute;bottom:.75em;left:.18em;width:40%;height:20%;max-height:13em;box-shadow:0 13px 8px #979797;transform:rotate(-2deg)}:not(pre)>code[class*=language-]:after,pre[class*=language-]:after{right:.75em;left:auto;transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}.token.cr:before,.token.lf:before,.token.tab:not(:empty):before{color:#e0d7d1}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-top:0;padding-bottom:0;padding-left:0}pre[data-line] code{position:relative;padding-left:4em}pre .line-highlight{margin-top:0}

/*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}.container{position:relative;max-width:1260px;margin:0 auto;padding:0 20px}.column,.columns,.container{width:100%;box-sizing:border-box}.column,.columns{float:left}@media (min-width:400px){.container{width:85%;padding:0}}@media (min-width:550px){.container{width:80%}.column,.columns{margin-left:4%}.column:first-child,.columns:first-child{margin-left:0}.one.column,.one.columns{width:4.66666666667%}.two.columns{width:13.3333333333%}.three.columns{width:22%}.four.columns{width:30.6666666667%}.five.columns{width:39.3333333333%}.six.columns{width:48%}.seven.columns{width:56.6666666667%}.eight.columns{width:65.3333333333%}.nine.columns{width:74%}.ten.columns{width:82.6666666667%}.eleven.columns{width:91.3333333333%}.twelve.columns{width:100%;margin-left:0}.one-third.column{width:30.6666666667%}.two-thirds.column{width:65.3333333333%}.one-half.column{width:48%}.offset-by-one.column,.offset-by-one.columns{margin-left:8.66666666667%}.offset-by-two.column,.offset-by-two.columns{margin-left:17.3333333333%}.offset-by-three.column,.offset-by-three.columns{margin-left:26%}.offset-by-four.column,.offset-by-four.columns{margin-left:34.6666666667%}.offset-by-five.column,.offset-by-five.columns{margin-left:43.3333333333%}.offset-by-six.column,.offset-by-six.columns{margin-left:52%}.offset-by-seven.column,.offset-by-seven.columns{margin-left:60.6666666667%}.offset-by-eight.column,.offset-by-eight.columns{margin-left:69.3333333333%}.offset-by-nine.column,.offset-by-nine.columns{margin-left:78%}.offset-by-ten.column,.offset-by-ten.columns{margin-left:86.6666666667%}.offset-by-eleven.column,.offset-by-eleven.columns{margin-left:95.3333333333%}.offset-by-one-third.column,.offset-by-one-third.columns{margin-left:34.6666666667%}.offset-by-two-thirds.column,.offset-by-two-thirds.columns{margin-left:69.3333333333%}.offset-by-one-half.column,.offset-by-one-half.columns{margin-left:52%}}html{font-size:62.5%}body{font-size:1.5em;line-height:1.6;font-weight:400;font-family:Raleway,HelveticaNeue,Helvetica Neue,Helvetica,Arial,sans-serif;color:#222}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:2rem;font-weight:300}h1{font-size:4rem;line-height:1.2}h1,h2{letter-spacing:-.1rem}h2{font-size:3.6rem;line-height:1.25}h3{font-size:3rem;line-height:1.3;letter-spacing:-.1rem}h4{font-size:2.4rem;line-height:1.35;letter-spacing:-.08rem}h5{font-size:1.8rem;line-height:1.5;letter-spacing:-.05rem}h6{font-size:1.5rem;line-height:1.6;letter-spacing:0}@media (min-width:550px){h1{font-size:5rem}h2{font-size:4.2rem}h3{font-size:3.6rem}h4{font-size:3rem}h5{font-size:2.4rem}h6{font-size:1.5rem}}p{margin-top:0}a{color:#1eaedb}a:hover{color:#0fa0ce}.button,button,input[type=button],input[type=reset],input[type=submit]{display:inline-block;height:38px;padding:0 30px;color:#555;text-align:center;font-size:11px;font-weight:600;line-height:38px;letter-spacing:.1rem;text-transform:uppercase;text-decoration:none;white-space:nowrap;background-color:transparent;border-radius:4px;border:1px solid #bbb;cursor:pointer;box-sizing:border-box}.button:focus,.button:hover,button:focus,button:hover,input[type=button]:focus,input[type=button]:hover,input[type=reset]:focus,input[type=reset]:hover,input[type=submit]:focus,input[type=submit]:hover{color:#333;border-color:#888;outline:0}.button.button-primary,button.button-primary,input[type=button].button-primary,input[type=reset].button-primary,input[type=submit].button-primary{color:#fff;background-color:#33c3f0;border-color:#33c3f0}.button.button-primary:focus,.button.button-primary:hover,button.button-primary:focus,button.button-primary:hover,input[type=button].button-primary:focus,input[type=button].button-primary:hover,input[type=reset].button-primary:focus,input[type=reset].button-primary:hover,input[type=submit].button-primary:focus,input[type=submit].button-primary:hover{color:#fff;background-color:#1eaedb;border-color:#1eaedb}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],select,textarea{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],textarea{-webkit-appearance:none;-moz-appearance:none;appearance:none}textarea{min-height:65px;padding-top:6px;padding-bottom:6px}input[type=email]:focus,input[type=number]:focus,input[type=password]:focus,input[type=search]:focus,input[type=tel]:focus,input[type=text]:focus,input[type=url]:focus,select:focus,textarea:focus{border:1px solid #33c3f0;outline:0}label,legend{display:block;margin-bottom:.5rem;font-weight:600}fieldset{padding:0;border-width:0}input[type=checkbox],input[type=radio]{display:inline}label>.label-body{display:inline-block;margin-left:.5rem;font-weight:400}ul{list-style:circle inside}ol{list-style:decimal inside}ol,ul{padding-left:0;margin-top:0}ol ol,ol ul,ul ol,ul ul{margin:1.5rem 0 1.5rem 3rem;font-size:90%}li{margin-bottom:1rem}div.highlight{font-size:90%;white-space:nowrap;background:#f1f1f1;border:1px solid #e1e1e1;border-radius:4px;margin-bottom:2.5rem}code{padding:.2rem .5rem;margin:0 .2rem}pre>code{display:block;padding:1rem 1.5rem;white-space:pre}td,th{padding:12px 15px;text-align:left;border-bottom:1px solid #e1e1e1}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}.button,button{margin-bottom:1rem}fieldset,input,select,textarea{margin-bottom:1.5rem}blockquote,dl,figure,form,ol,p,pre,table,ul{margin-bottom:2.5rem}.u-full-width{width:100%;box-sizing:border-box}.u-max-full-width{max-width:100%;box-sizing:border-box}.u-pull-right{float:right}.u-pull-left{float:left}hr{margin-top:3rem;margin-bottom:3.5rem;border-width:0;border-top:1px solid #e1e1e1}.container:after,.row:after,.u-cf{content:"";display:table;clear:both}.highlight .hll{background-color:#ffc}.highlight .c{color:#999}.highlight .err{color:#a00;background-color:#faa}.highlight .k{color:#069}.highlight .o{color:#555}.highlight .cm{color:#09f;font-style:italic}.highlight .cp{color:#099}.highlight .c1,.highlight .cs{color:#999}.highlight .gd{background-color:#fcc;border:1px solid #c00}.highlight .ge{font-style:italic}.highlight .gr{color:red}.highlight .gh{color:#030}.highlight .gi{background-color:#cfc;border:1px solid #0c0}.highlight .go{color:#aaa}.highlight .gp{color:#009}.highlight .gu{color:#030}.highlight .gt{color:#9c6}.highlight .kc,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr{color:#069}.highlight .kt{color:#078}.highlight .m{color:#f60}.highlight .s{color:#d44950}.highlight .na{color:#4f9fcf}.highlight .nb{color:#366}.highlight .nc{color:#0a8}.highlight .no{color:#360}.highlight .nd{color:#99f}.highlight .ni{color:#999}.highlight .ne{color:#c00}.highlight .nf{color:#c0f}.highlight .nl{color:#99f}.highlight .nn{color:#0cf}.highlight .nt{color:#2f6f9f}.highlight .nv{color:#033}.highlight .ow{color:#000}.highlight .w{color:#bbb}.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:#f60}.highlight .sb,.highlight .sc{color:#c30}.highlight .sd{color:#c30;font-style:italic}.highlight .s2,.highlight .se,.highlight .sh{color:#c30}.highlight .si{color:#a00}.highlight .sx{color:#c30}.highlight .sr{color:#3aa}.highlight .s1{color:#c30}.highlight .ss{color:#fc3}.highlight .bp{color:#366}.highlight .vc,.highlight .vg,.highlight .vi{color:#033}.highlight .il{color:#f60}.css .nt+.nt,.css .o,.css .o+.nt{color:#999}body{font-size:1.8em}h2,h4{font-size:2.6rem}@media (min-width:550px){h2,h4{font-size:2.7rem}}kbd{padding:.1em;border-radius:3px;border:1px solid #ccc;color:#333;display:inline-block;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 2px #fff;background-color:#f7f7f7;text-shadow:0 1px 0 #fff}figcaption{text-align:center;font-style:italic;color:#777;display:block;margin-bottom:2em}.sidebar h1{font-size:2.4em}.sidebar__sitetitle{color:#af0000}.sidebar__twitter{display:none;margin-top:2rem}.footer__twitter{display:none}.footer__copyright{float:right;font-size:.7em}.right-padded{padding-right:2rem}@media (max-width:550px){.sidebar h1,.sidebar p{margin-bottom:.5rem}.sidebar{padding-bottom:1rem;margin-bottom:1rem;border-bottom:1px solid grey}.footer__twitter{display:inline-block}}@media (min-width:550px){.sidebar h1{transform:rotate(-90deg);text-align:right;margin-top:150px;margin-bottom:100px}.sidebar__twitter{display:block}.copyright{margin-top:40px}}.sidebar p{text-align:justify;font-size:.8em}.sidebar h1 a{text-decoration:none}nav a{display:block}.pagination{margin-top:20px}.center,.pagination{text-align:center}.expand{width:80%}.teaser{margin-bottom:70px}.teaser .date{display:block;margin-top:-20px;margin-bottom:20px;text-align:right}.teaser h3 a{text-decoration:none}.page-info{text-align:right;margin-bottom:40px}article iframe,article img{display:block;margin:20px auto;max-width:100%}article div.highlight,article iframe,article img{box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}article div.highlight{scroll-behavior:auto}blockquote{background:#f9f9f9;border-left:10px solid #ccc;padding:.5em 10px;quotes:"\201C""\201D""\2018""\2019"}blockquote:before{color:#ccc;content:"\201D";font-size:4em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}div.seriestoc{background:#f9f9f9;border-left:10px solid #ccc;padding:.5em 10px;font-size:1em}div.seriestoc:before{color:#ccc;content:":";font-size:4em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}.blog-post__content>h3:first-of-type{text-align:right;border-radius:25px 25px 0 0;font-size:1.2em;background-color:#777;color:#fff;margin-bottom:0;padding:2px 20px 2px 0;font-style:italic}.blog-post__content>ol:first-of-type{list-style-type:upper-roman;background:#eff;border:1px solid #777;border-radius:0 0 25px 25px;margin-top:0;list-style-position:outside;padding:10px 10px 10px 45px}.blog-post__footer{margin:1rem 0 2rem}.article-tags{margin-left:.3rem}.article-tags--tag{margin-left:.5rem}.article-tags--tag:after{margin-left:.5rem;content:"|"}.article-tags--tag:last-child:after{content:""}.blog-post__pagination{display:flex;justify-content:space-between;margin-bottom:2rem}.blog-post__pagination--previous{text-decoration:none;margin:0 1rem}.blog-post__pagination--previous:hover{text-decoration:underline}.blog-post__pagination--previous:before{content:"\21A4   "}.blog-post__pagination--next:after{content:" \21A6"}.blog-post__pagination--next{text-decoration:none;margin:0 1rem}.blog-post__pagination--next:hover{text-decoration:underline}code.language-text{position:relative;padding:0;border-radius:.1em;margin-left:.2em;margin-right:.2em;color:#a55;border-bottom:1px solid rgba(200,100,100,.1);display:inline;white-space:normal}</style><meta name="generator" content="Gatsby 2.23.3"/><title data-react-helmet="true">2D-Historization in a graph database</title><link data-react-helmet="true" href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css"/><meta data-react-helmet="true" name="description" content="Content from Frank Quednau about dev and fields of interest."/><meta data-react-helmet="true" name="keywords" content="patterns, programming, neo4j"/><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-b3b573358bfc66d89e1e95dbf8319c09.css"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" title="Realfiction RSS" href="/atom.xml"/><link rel="icon" href="/favicon-32x32.png?v=1198f979e9570dca0344937fffa12794"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=1198f979e9570dca0344937fffa12794"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=1198f979e9570dca0344937fffa12794"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-a9241beb6a28b543aa8c.js"/><link as="script" rel="preload" href="/framework-75da9754c2a76bbaf08a.js"/><link as="script" rel="preload" href="/app-0e2bc70403aecc61a331.js"/><link as="script" rel="preload" href="/styles-9b6f388623a2ec93d35f.js"/><link as="script" rel="preload" href="/commons-1786a38fae20bdbb3746.js"/><link as="script" rel="preload" href="/component---src-templates-article-template-js-106f153950e91bc0de89.js"/><link as="fetch" rel="preload" href="/page-data/2017/01/27/2d-historization-in-a-graph-database/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="container"><div class="row"><div class="two columns right-padded"><div class="sidebar"><h1><a class="sidebar__sitetitle" href="/">Realfiction</a></h1><p>Content from Frank Quednau about dev and fields of interest.</p><nav><a href="/tags">Tags</a></nav><div class="sidebar__twitter"><a href="https://twitter.com/fquednau?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-size="large" data-show-count="false" data-show-screen-name="false">Follow @fquednau</a></div></div></div><div class="nine columns"><article><h1>2D-Historization in a graph database</h1><div class="page-info"><span>January 27, 2017</span> in<span class="article-tags"><a class="article-tags--tag" href="/tags/patterns">patterns</a><a class="article-tags--tag" href="/tags/programming">programming</a><a class="article-tags--tag" href="/tags/neo4j">neo4j</a></span></div><div class="blog-post__content"><h3>2D Historization series</h3>
<ol>
<li><a href="/2016/12/18/2d-or-bitemporal-historization-a-primer">2D or bitemporal Historization: A primer</a></li>
<li>2D-Historization in a graph database</li>
<li><a href="/2017/01/30/simplify-the-bitemporal-neo4j-query-with-a-user-defined-function">Simplify the bitemporal Neo4J query with a user-defined function</a></li>
</ol>
<blockquote>
<p><em>Note:</em>
This text assumes that you know a little bit about graph databases
and Neo4J in particular. If you don't know Neo4J, please have a read
at <a href="https://neo4j.com/docs/developer-manual/current/introduction/">Neo4J's documentation</a></p>
</blockquote>
<p>The <a href="/2016/12/18/2d-or-bitemporal-historization-a-primer">introduction to 2D-historization</a> dealt with the theory behind representing
and reading state changes of your data in a model where we keep the time when
the state change was recorded together with the actual time, the time where we want
the state change to be applied in the context of whatever it is the application
is representing.</p>
<p>My point of orientation when implementing 2D-historized data was Ian Robinson's
<a href="http://iansrobinson.com/2014/05/13/time-based-versioned-graphs/">post on time-based versioned graphs</a></p>
<p>In here we find the following principles when representing data in the graph:</p>
<ul>
<li>We extract the immutable data about some entity into a single <strong>node</strong>. This
would typically be the data that uniquely identifies the entity. Under certain
circumstances this may be just some id, but depending on your case, more data
could be stored in that node</li>
<li>Any data that can change over time is extracted to another node, attached
to the immutable one via a relationship that stores the <strong>actual</strong> and
<strong>recorded</strong> time when the data node was created.</li>
<li>Repeat for any additional changes that are introduced to the entity.</li>
</ul>
<p>Here is some cypher to create an example:</p>
<div class="gatsby-highlight" data-language="cypher"><pre class="language-cypher"><code class="language-cypher">CREATE (p:Person { id: 112245 })
CREATE (pd:PersonData { name: &#39;Joe Bloggs&#39; })-[:EXPANDS { recorded: 10, actual: 10}]-&gt;(p)
CREATE (pd2:PersonData { name: &#39;Joe Gonzalez&#39; })-[:EXPANDS { recorded: 20, actual: 30}]-&gt;(p)</code></pre></div>
<p>Consider the <em>actual</em> and <em>recorded</em> values to be e.g. days since inception...</p>
<p><img src="/assets/2DHistory3.png"></p>
<p>The query to get the right history of PersonData changes is pretty straightforward:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">MATCH (pd:PersonData)-[r]-(p) 
WHERE p.id = 112245
AND r.recorded &lt;= 30
RETURN r.recorded, r.actual, pd.name
ORDER BY r.recorded DESC</code></pre></div>
<p><em>(assuming existence of only the EXPANDS relationship)</em></p>
<p>However, we've previously seen that some entries may be cancelled out,
e.g. when you record a future state and later on you record a new state
that will be valid before the previously recorded one.</p>
<p>We can consider the following example:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">CREATE (p:Person { id: 665544 })
CREATE (pd:PersonData { name: &#39;A. Brannigan&#39; })-[:EXPANDS { recorded: 10, actual: 10}]-&gt;(p)
CREATE (pd2:PersonData { name: &#39;A. Durington&#39; })-[:EXPANDS { recorded: 20, actual: 40}]-&gt;(p)
CREATE (pd3:PersonData { name: &#39;A. Lovegood&#39; })-[:EXPANDS { recorded: 30, actual: 30}]-&gt;(p)</code></pre></div>
<p>The logic how such state changes should be considered is explained
<a href="/2016/12/18/2d-or-bitemporal-historization-a-primer">in the previous blog post</a>. To recap:</p>
<ul>
<li>move backwards along the recorded time axis.</li>
<li>add events to the history whose <strong>actual</strong> time lies before the last state
collected</li>
<li>ignore those whose <strong>actual</strong> time lies beyond the last state collected.</li>
</ul>
<p>Can we express this in Cypher?
Well, it's not pretty, but it's possible<sup>*)</sup>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">MATCH (pd:PersonData)-[r]-(p) 
WHERE p.id = 665544 AND r.recorded &lt;= 30
WITH { data: pd, recorded: r.recorded, actual: r.actual } as data
WITH data ORDER BY data.recorded DESC
WITH reduce(relevant = [], d in collect(data) | 
CASE 
WHEN last(relevant) IS NULL OR d.actual &lt; last(relevant).actual THEN relevant+d 
ELSE relevant END) 
AS data
UNWIND data AS final 
RETURN final.actual, final.data</code></pre></div>
<p>Depending at which point in time you look at the state you now get two different
histories:</p>
<p><img src="/assets/2DHistory4.png"></p>
<p>or</p>
<p><img src="/assets/2DHistory5.png"></p>
<p>What the query does is to </p>
<ul>
<li>identify the immutable node we are interested in and establish the data
we will be considering</li>
<li>order it descending based on the recorded time </li>
<li><a href="http://neo4j.com/docs/developer-manual/current/cypher/functions/list/#functions-reduce">reducing</a> the data, thereby rejecting those states that have been
cancelled by subsequent state entries.</li>
</ul>
<p>As is often the case with graphs, there are quite a few ways you can go about storing data
with meaningful relationships. Other representations could be</p>
<ul>
<li>Putting the emphasis entering the queries purely through a point in time.
In this case you could try and construct a representation with the help of
a <a href="http://graphaware.com/neo4j/2014/08/20/graphaware-neo4j-timetree.html">time tree</a>.</li>
<li>Putting the emphasis on business transactions that summarize all
state changes contained in said transaction.</li>
</ul>
<p>As usual with graphs, think in advance the kind of questions
you will want to ask :)</p>
<p>*)
<em>Disclaimer: I am no cypher expert. The query expresses the logic outlined in the first blog post with some additional noise, some compaction may  still be possible.</em></p></div><div class="blog-post__footer"><a href="https://mobile.twitter.com/search?q=https%3A%2F%2Frealfiction.net%2F2017/01/27/2d-historization-in-a-graph-database" target="_blank" rel="noopener noreferrer">Discuss on Twitter ⇲</a></div><div class="blog-post__pagination"><a class="blog-post__pagination--previous" href="/2017/01/18/an-outsiders-guide-to-gerrymandering">An outsider&#x27;s guide to gerrymandering</a><a class="blog-post__pagination--next" href="/2017/01/30/simplify-the-bitemporal-neo4j-query-with-a-user-defined-function">Simplify the bitemporal Neo4J query with a user-defined function</a></div></article></div></div><div class="row"><div class="footer__twitter"><a href="https://twitter.com/fquednau?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-size="large" data-show-count="false" data-show-screen-name="false">Follow @fquednau</a> </div><p class="footer__copyright">© Frank Quednau <!-- -->2020</p></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  window.excludeGAPaths=[/^(?:\/404)$/];
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-1812710-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2017/01/27/2d-historization-in-a-graph-database";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-0e2bc70403aecc61a331.js"],"component---src-pages-404-js":["/component---src-pages-404-js-28503b239a43329520b3.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b3f7d63e43bb68c468d5.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-fe5d28a675e04ae0a358.js"],"component---src-templates-article-template-js":["/component---src-templates-article-template-js-106f153950e91bc0de89.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-b64488dd4664fd68f34a.js"]};/*]]>*/</script><script src="/component---src-templates-article-template-js-106f153950e91bc0de89.js" async=""></script><script src="/commons-1786a38fae20bdbb3746.js" async=""></script><script src="/styles-9b6f388623a2ec93d35f.js" async=""></script><script src="/app-0e2bc70403aecc61a331.js" async=""></script><script src="/framework-75da9754c2a76bbaf08a.js" async=""></script><script src="/webpack-runtime-a9241beb6a28b543aa8c.js" async=""></script></body></html>