<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/app.a03716562d1e590f30ef.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{position:relative;margin:.5em 0;overflow:visible;padding:0}pre[class*=language-]>code{position:relative;border-left:10px solid #358ccb;box-shadow:-1px 0 0 0 #358ccb,0 0 0 1px #dfdfdf;background-color:#fdfdfd;background-image:linear-gradient(transparent 50%,rgba(69,142,209,.04) 0);background-size:3em 3em;background-origin:content-box;background-attachment:local}code[class*=language]{max-height:inherit;height:inherit;padding:0 1em;display:block;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdfdfd;box-sizing:border-box;margin-bottom:1em}:not(pre)>code[class*=language-]{position:relative;padding:.2em;border-radius:.3em;color:#c92c2c;border:1px solid rgba(0,0,0,.1);display:inline;white-space:normal}pre[class*=language-]:after,pre[class*=language-]:before{content:"";z-index:-2;display:block;position:absolute;bottom:.75em;left:.18em;width:40%;height:20%;max-height:13em;box-shadow:0 13px 8px #979797;-webkit-transform:rotate(-2deg);transform:rotate(-2deg)}:not(pre)>code[class*=language-]:after,pre[class*=language-]:after{right:.75em;left:auto;-webkit-transform:rotate(2deg);transform:rotate(2deg)}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#7d8b99}.token.punctuation{color:#5f6364}.token.boolean,.token.constant,.token.deleted,.token.function-name,.token.number,.token.property,.token.symbol,.token.tag{color:#c92c2c}.token.attr-name,.token.builtin,.token.char,.token.function,.token.inserted,.token.selector,.token.string{color:#2f9c0a}.token.entity,.token.operator,.token.url,.token.variable{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.class-name,.token.keyword{color:#1990b8}.token.important,.token.regex{color:#e90}.language-css .token.string,.style .token.string{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.important{font-weight:400}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.namespace{opacity:.7}@media screen and (max-width:767px){pre[class*=language-]:after,pre[class*=language-]:before{bottom:14px;box-shadow:none}}.token.cr:before,.token.lf:before,.token.tab:not(:empty):before{color:#e0d7d1}pre[class*=language-].line-numbers.line-numbers{padding-left:0}pre[class*=language-].line-numbers.line-numbers code{padding-left:3.8em}pre[class*=language-].line-numbers.line-numbers .line-numbers-rows{left:0}pre[class*=language-][data-line]{padding-top:0;padding-bottom:0;padding-left:0}pre[data-line] code{position:relative;padding-left:4em}pre .line-highlight{margin-top:0}</style><style data-href="/1.9d69e64ecb5d12fe3c4a.css">/*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}.container{position:relative;max-width:1260px;margin:0 auto;padding:0 20px}.column,.columns,.container{width:100%;box-sizing:border-box}.column,.columns{float:left}@media (min-width:400px){.container{width:85%;padding:0}}@media (min-width:550px){.container{width:80%}.column,.columns{margin-left:4%}.column:first-child,.columns:first-child{margin-left:0}.one.column,.one.columns{width:4.66666666667%}.two.columns{width:13.3333333333%}.three.columns{width:22%}.four.columns{width:30.6666666667%}.five.columns{width:39.3333333333%}.six.columns{width:48%}.seven.columns{width:56.6666666667%}.eight.columns{width:65.3333333333%}.nine.columns{width:74%}.ten.columns{width:82.6666666667%}.eleven.columns{width:91.3333333333%}.twelve.columns{width:100%;margin-left:0}.one-third.column{width:30.6666666667%}.two-thirds.column{width:65.3333333333%}.one-half.column{width:48%}.offset-by-one.column,.offset-by-one.columns{margin-left:8.66666666667%}.offset-by-two.column,.offset-by-two.columns{margin-left:17.3333333333%}.offset-by-three.column,.offset-by-three.columns{margin-left:26%}.offset-by-four.column,.offset-by-four.columns{margin-left:34.6666666667%}.offset-by-five.column,.offset-by-five.columns{margin-left:43.3333333333%}.offset-by-six.column,.offset-by-six.columns{margin-left:52%}.offset-by-seven.column,.offset-by-seven.columns{margin-left:60.6666666667%}.offset-by-eight.column,.offset-by-eight.columns{margin-left:69.3333333333%}.offset-by-nine.column,.offset-by-nine.columns{margin-left:78%}.offset-by-ten.column,.offset-by-ten.columns{margin-left:86.6666666667%}.offset-by-eleven.column,.offset-by-eleven.columns{margin-left:95.3333333333%}.offset-by-one-third.column,.offset-by-one-third.columns{margin-left:34.6666666667%}.offset-by-two-thirds.column,.offset-by-two-thirds.columns{margin-left:69.3333333333%}.offset-by-one-half.column,.offset-by-one-half.columns{margin-left:52%}}html{font-size:62.5%}body{font-size:1.5em;line-height:1.6;font-weight:400;font-family:Raleway,HelveticaNeue,Helvetica Neue,Helvetica,Arial,sans-serif;color:#222}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:2rem;font-weight:300}h1{font-size:4rem;line-height:1.2}h1,h2{letter-spacing:-.1rem}h2{font-size:3.6rem;line-height:1.25}h3{font-size:3rem;line-height:1.3;letter-spacing:-.1rem}h4{font-size:2.4rem;line-height:1.35;letter-spacing:-.08rem}h5{font-size:1.8rem;line-height:1.5;letter-spacing:-.05rem}h6{font-size:1.5rem;line-height:1.6;letter-spacing:0}@media (min-width:550px){h1{font-size:5rem}h2{font-size:4.2rem}h3{font-size:3.6rem}h4{font-size:3rem}h5{font-size:2.4rem}h6{font-size:1.5rem}}p{margin-top:0}a{color:#1eaedb}a:hover{color:#0fa0ce}.button,button,input[type=button],input[type=reset],input[type=submit]{display:inline-block;height:38px;padding:0 30px;color:#555;text-align:center;font-size:11px;font-weight:600;line-height:38px;letter-spacing:.1rem;text-transform:uppercase;text-decoration:none;white-space:nowrap;background-color:transparent;border-radius:4px;border:1px solid #bbb;cursor:pointer;box-sizing:border-box}.button:focus,.button:hover,button:focus,button:hover,input[type=button]:focus,input[type=button]:hover,input[type=reset]:focus,input[type=reset]:hover,input[type=submit]:focus,input[type=submit]:hover{color:#333;border-color:#888;outline:0}.button.button-primary,button.button-primary,input[type=button].button-primary,input[type=reset].button-primary,input[type=submit].button-primary{color:#fff;background-color:#33c3f0;border-color:#33c3f0}.button.button-primary:focus,.button.button-primary:hover,button.button-primary:focus,button.button-primary:hover,input[type=button].button-primary:focus,input[type=button].button-primary:hover,input[type=reset].button-primary:focus,input[type=reset].button-primary:hover,input[type=submit].button-primary:focus,input[type=submit].button-primary:hover{color:#fff;background-color:#1eaedb;border-color:#1eaedb}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],select,textarea{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],textarea{-webkit-appearance:none;-moz-appearance:none;appearance:none}textarea{min-height:65px;padding-top:6px;padding-bottom:6px}input[type=email]:focus,input[type=number]:focus,input[type=password]:focus,input[type=search]:focus,input[type=tel]:focus,input[type=text]:focus,input[type=url]:focus,select:focus,textarea:focus{border:1px solid #33c3f0;outline:0}label,legend{display:block;margin-bottom:.5rem;font-weight:600}fieldset{padding:0;border-width:0}input[type=checkbox],input[type=radio]{display:inline}label>.label-body{display:inline-block;margin-left:.5rem;font-weight:400}ul{list-style:circle inside}ol{list-style:decimal inside}ol,ul{padding-left:0;margin-top:0}ol ol,ol ul,ul ol,ul ul{margin:1.5rem 0 1.5rem 3rem;font-size:90%}li{margin-bottom:1rem}div.highlight{font-size:90%;white-space:nowrap;background:#f1f1f1;border:1px solid #e1e1e1;border-radius:4px;margin-bottom:2.5rem}code{padding:.2rem .5rem;margin:0 .2rem}pre>code{display:block;padding:1rem 1.5rem;white-space:pre}td,th{padding:12px 15px;text-align:left;border-bottom:1px solid #e1e1e1}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}.button,button{margin-bottom:1rem}fieldset,input,select,textarea{margin-bottom:1.5rem}blockquote,dl,figure,form,ol,p,pre,table,ul{margin-bottom:2.5rem}.u-full-width{width:100%;box-sizing:border-box}.u-max-full-width{max-width:100%;box-sizing:border-box}.u-pull-right{float:right}.u-pull-left{float:left}hr{margin-top:3rem;margin-bottom:3.5rem;border-width:0;border-top:1px solid #e1e1e1}.container:after,.row:after,.u-cf{content:"";display:table;clear:both}.highlight .hll{background-color:#ffc}.highlight .c{color:#999}.highlight .err{color:#a00;background-color:#faa}.highlight .k{color:#069}.highlight .o{color:#555}.highlight .cm{color:#09f;font-style:italic}.highlight .cp{color:#099}.highlight .c1,.highlight .cs{color:#999}.highlight .gd{background-color:#fcc;border:1px solid #c00}.highlight .ge{font-style:italic}.highlight .gr{color:red}.highlight .gh{color:#030}.highlight .gi{background-color:#cfc;border:1px solid #0c0}.highlight .go{color:#aaa}.highlight .gp{color:#009}.highlight .gu{color:#030}.highlight .gt{color:#9c6}.highlight .kc,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr{color:#069}.highlight .kt{color:#078}.highlight .m{color:#f60}.highlight .s{color:#d44950}.highlight .na{color:#4f9fcf}.highlight .nb{color:#366}.highlight .nc{color:#0a8}.highlight .no{color:#360}.highlight .nd{color:#99f}.highlight .ni{color:#999}.highlight .ne{color:#c00}.highlight .nf{color:#c0f}.highlight .nl{color:#99f}.highlight .nn{color:#0cf}.highlight .nt{color:#2f6f9f}.highlight .nv{color:#033}.highlight .ow{color:#000}.highlight .w{color:#bbb}.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo{color:#f60}.highlight .sb,.highlight .sc{color:#c30}.highlight .sd{color:#c30;font-style:italic}.highlight .s2,.highlight .se,.highlight .sh{color:#c30}.highlight .si{color:#a00}.highlight .sx{color:#c30}.highlight .sr{color:#3aa}.highlight .s1{color:#c30}.highlight .ss{color:#fc3}.highlight .bp{color:#366}.highlight .vc,.highlight .vg,.highlight .vi{color:#033}.highlight .il{color:#f60}.css .nt+.nt,.css .o,.css .o+.nt{color:#999}body{font-size:1.8em}.sidebar h1{font-size:2.4em}@media (min-width:550px){.sidebar h1{-webkit-transform:rotate(-90deg);transform:rotate(-90deg);text-align:right;margin-top:150px;margin-bottom:100px}.copyright{margin-top:40px}}.sidebar p{text-align:justify;font-size:.8em}.sidebar h1 a{text-decoration:none}nav a{display:block}.pagination{margin-top:20px}.center,.pagination{text-align:center}.expand{width:80%}.teaser{margin-bottom:70px}.teaser .date{display:block;margin-top:-30px;margin-bottom:20px;text-align:right}.teaser h3 a{text-decoration:none}.page-info{text-align:right;margin-bottom:40px}article iframe,article img{display:block;margin:20px auto;max-width:100%}article div.highlight,article iframe,article img{box-shadow:0 8px 16px 0 rgba(0,0,0,.2),0 6px 20px 0 rgba(0,0,0,.19)}article div.highlight{scroll-behavior:auto}blockquote{background:#f9f9f9;border-left:10px solid #ccc;padding:.5em 10px;quotes:"\201C" "\201D" "\2018" "\2019"}blockquote:before{color:#ccc;content:"\201D";font-size:4em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}div.seriestoc{background:#f9f9f9;border-left:10px solid #ccc;padding:.5em 10px;font-size:1em}div.seriestoc:before{color:#ccc;content:":";font-size:4em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}.blog-post-content>h3:first-of-type{text-align:right;border-radius:25px 25px 0 0;font-size:1.2em;background-color:#777;color:#fff;margin-bottom:0;padding:2px 20px 2px 0;font-style:italic}.blog-post-content>ol:first-of-type{list-style-type:upper-roman;background:#eff;border:1px solid #777;border-radius:0 0 25px 25px;margin-top:0;list-style-position:outside;padding:10px 10px 10px 45px}.article-tags{margin-left:.3rem}.article-tags--tag{margin-left:.5rem}.article-tags--tag:after{margin-left:.5rem;content:"|"}.article-tags--tag:last-child:after{content:""}.article-pagination{display:flex;justify-content:space-between;margin-bottom:2rem}.article-pagination--previous{text-decoration:none;margin:0 1rem}.article-pagination--previous:hover{text-decoration:underline}.article-pagination--previous:before{content:"\21A4   "}.article-pagination--next:after{content:" \21A6"}.article-pagination--next{text-decoration:none;margin:0 1rem}.article-pagination--next:hover{text-decoration:underline}</style><meta name="generator" content="Gatsby 2.0.60"/><title data-react-helmet="true">Separating MS Bot&#x27;s soul from its body</title><link data-react-helmet="true" href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css"/><meta data-react-helmet="true" name="description" content="Content from Frank Quednau about programming and fields of interest."/><meta data-react-helmet="true" name="keywords" content="dotnet, programming, software-development, cloud"/><link rel="alternate" type="application/rss+xml" title="Realfiction RSS" href="/atom.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/component---src-templates-article-template-js-77b1cf90d2b01be70bbb.js"/><link as="script" rel="preload" href="/1-c5e48db84d3be9fa8158.js"/><link as="script" rel="preload" href="/0-31cb8205322dc8b322a6.js"/><link as="script" rel="preload" href="/app-6e0292f33bdbd16fe1a4.js"/><link as="script" rel="preload" href="/webpack-runtime-82cffdf9266513af319a.js"/><link rel="preload" href="/static/d/773/path---2017-06-25-separating-ms-bots-soul-from-its-body-1-ed-b91-o6ECm2nYA20kn7Aor1hrYkdlVUg.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="container"><div class="row"><div class="two columns"><div class="sidebar"><h1><a href="/">Realfiction</a></h1><p>Content from Frank Quednau about programming and fields of interest.</p><nav><a href="/">Home</a><a href="/tags">Tags</a></nav></div></div><div class="ten columns"><article><h1>Separating MS Bot&#x27;s soul from its body</h1><div class="page-info"><span>June 25, 2017</span> in<span class="article-tags"><a class="article-tags--tag" href="/tags/dotnet">dotnet</a><a class="article-tags--tag" href="/tags/programming">programming</a><a class="article-tags--tag" href="/tags/software-development">software-development</a><a class="article-tags--tag" href="/tags/cloud">cloud</a></span></div><div class="blog-post-content"><p>For <a href="http://www.isolutions.ch/Seiten/default.aspx">my new gig</a> I had the chance to look into <a href="https://dev.botframework.com/">Microsoft's Bot framework</a>. Said framework exists to</p>
<ul>
<li>provide the foundation of setting up chat <em>Dialogs</em>, similarly to how you would set up screen flows.</li>
<li>Through its mechanisms of (de)serialization provide a suspendable state machine to keep a conversation with the user going and wire up necessary services like pre-canned dialogs or intention revealing services like <a href="https://www.luis.ai/home/index">LUIS</a></li>
<li>Through the registration in the bot portal provide the basis of having bots serve multiple channels (think web, but also slack, Skype, Skype for Business, etc.)</li>
</ul>
<p>The bot API comes in two flavours:</p>
<h3>The IDialog<T> interface</h3>
<p>This is the basic building block of bots. Based on this interface you can package your functionality like MS has done it for example with the in-built Form dialog that will ask questions dictated by the shape of a provided object or the <a href="https://github.com/Microsoft/BotBuilder-Location">location dialog</a>, a pre-canned dialog to collect location data within a conversation with the help of Bing Maps. The type argument of a Dialog refers to its return value. In the case of the location dialog this is e.g. a <strong>Place</strong> object.</p>
<h3>The Chain fluent API</h3>
<p>This API allows to chain those callbacks, switches and similar things that you would usually place into a Dialog as lambdas and such construct a bot without having to explicitly define Dialogs yourself.</p>
<p>My main quarrel with the API is that back in your mind you always need to consider that your Dialog must be serializable. This puts a few restrictions on your design, e.g. how you treat your injected services. Also, with the default serializer you will run into trouble when in your continuations, which you usually express as lambdas, you try to access an instance field of the dialog. In this case the serialization system will just complain bitterly that you simply cannot do that. To get out of that problem, your continuations get access to the state data through an interface passed in.</p>
<p>Another thing is that the API does not make it easy for you to separate the <em>"soul"</em> of your Dialog, the business logic, from the necessary plumbing of the Dialog API, nor is there any guidance on how to do that.</p>
<p>Granted, all dependencies are accessible through interfaces, such that an <code class="language-text">IDialog</code> implementation is in theory testable. However, you'll still have the issue of having a class whose structure is predominantly shaped by the technicalities of the Bot API while containing the logic of your conversation.</p>
<p>What follows is one way to get that separation done. The idea is to define a <em>Saga</em>, where I am using the word in the sense as it is <a href="https://docs.particular.net/nservicebus/sagas/">introduced e.g. by NServiceBus</a>.</p>
<h3>the bot's body</h3>
<p>Let us introduce an IDialog implementation that supports kicking off a so-called <strong>Customer Saga</strong>.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">Serializable</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSagaDrivenDialog</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">:</span> IDialog<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> ICustomerSaga
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Task</span> <span class="token function">StartAsync</span><span class="token punctuation">(</span><span class="token class-name">IDialogContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> customerSaga <span class="token operator">=</span> Conversation<span class="token punctuation">.</span>Container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">SetSaga</span><span class="token punctuation">(</span>customerSaga<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>WaitForUserToStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICustomerSaga</span>
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">string</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The container (which btw is an AutoFac container, i.e. thank the decent engineers working on this that it's not Unity) resolves our Saga and is directly put into the <strong>context</strong>. Context is an object which also implements <code class="language-text">IBotData</code>, an interface which abstracts away the access to data which consitutes the state of your conversation and user interaction. Then we wait for the user to talk to our bot. Once this happens...</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">WaitForUserToStart</span><span class="token punctuation">(</span><span class="token class-name">IDialogContext</span> context<span class="token punctuation">,</span> IAwaitable<span class="token operator">&lt;</span>IMessageActivity<span class="token operator">></span> result<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> r <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>ConversationData<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"saga"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">T</span> saga<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> whatNext <span class="token operator">=</span> <span class="token keyword">await</span> saga<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HandleWhatNext</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> whatNext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We await the result that contains amongst other info the user's input, obtain/deserialize the saga from the bot's state, and call the <strong>Start</strong> method of the saga with the user's input. <strong>whatNext</strong> is just a sloppy name for an object that will help us to dispatch what should happen next in the dialog.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token keyword">void</span> <span class="token function">HandleWhatNext</span><span class="token punctuation">(</span><span class="token class-name">IDialogContext</span> context<span class="token punctuation">,</span> <span class="token class-name">ProcessResponse</span> whatNext<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    whatNext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Being</span><span class="token punctuation">&lt;</span><span class="token class-name">ContinuedResponse</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>SetContinuation<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>whatNext<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token class-name">TerminateDialog</span> td<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token class-name">AskForAddress</span> afa<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">case</span> <span class="token class-name">PromptResponse</span> pr<span class="token punctuation">:</span>
            PromptDialog<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>dialogContext<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">;</span>
                <span class="token keyword">var</span> continuation <span class="token operator">=</span> <span class="token keyword">await</span> dialogContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CallContinuation</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">HandleWhatNext</span><span class="token punctuation">(</span>dialogContext<span class="token punctuation">,</span> continuation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> pr<span class="token punctuation">.</span>Prompt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">ProcessResponse</code> is the name of the abstract class from which all actions emanating from the Saga inherit. With the new switch enhancement we can now also pattern-match on the actual return type halfway decently even in C#. Also of note is the first line that will store the continuation of said action <strong>if</strong> the action is a <code class="language-text">ContinuedResponse</code>. All <code class="language-text">ProcessResponse</code> types are a <code class="language-text">ContinuedResponse</code> apart from those that, well, end the dialog and hence have no continuation, e.g. the <code class="language-text">TerminateDialog</code> type.</p>
<p>The code above shows one example how the Saga's action is handled. Here, a Bot Dialog helper is used to prompt the user with some text, then, with the user's response the continuation is called that had previously been stored in the context.</p>
<p>What happens in <code class="language-text">CallContinuation</code>?</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span> <span class="token generic-method"><span class="token function">CallContinuation</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IDialogContext</span> ctx<span class="token punctuation">,</span> <span class="token keyword">object</span> input<span class="token punctuation">)</span> 
    <span class="token keyword">where</span> T <span class="token punctuation">:</span>  ICustomerSaga
<span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>ConversationData<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"saga"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">T</span> saga<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>ConversationData<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"continuation"</span><span class="token punctuation">,</span> 
        <span class="token keyword">out</span> <span class="token class-name">ContinuedResponse</span> continuation<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> <span class="token keyword">value</span> <span class="token operator">=</span> <span class="token keyword">await</span> continuation<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>saga<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The saga may have changed its internal state and </span>
        <span class="token comment">// wants back into the bag</span>
        ctx<span class="token punctuation">.</span><span class="token function">SetSaga</span><span class="token punctuation">(</span>saga<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ProcessResponse<span class="token punctuation">.</span>NoOp<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Here the saga is taken from the context as well as a previously stored continuation. Once both are obtained, the continuation is called with the current input that has been provided by the bot framework. This could be a simple text from the user, or some complex object from some child dialog that has just completed. Also of importance is that after having obtained the next action from the Saga, the saga is put back into its box, as it may have changed its internal state (which is kind of the whole point of a Saga).</p>
<p>In the continuation call we get a little bit dirty:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span> <span class="token function">Call</span><span class="token punctuation">(</span><span class="token keyword">object</span> saga<span class="token punctuation">,</span> <span class="token keyword">object</span> input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> method <span class="token operator">=</span> saga<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>Continuation<span class="token punctuation">,</span> 
      BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Public <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">FromResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ProcessResponse</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">TerminateDialog</span> <span class="token punctuation">{</span> 
                Text <span class="token operator">=</span> $<span class="token string">"Failure to identify a continuation from {Continuation}"</span> 
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>saga<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> input <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span><span class="token punctuation">)</span>result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>A sprinkle of reflection helps us break the chains of serialization. My first attempt had been to store an actual delegate
as continuation, but since those continuations need to be serializable, the default serializer was in deep trouble with those.
Hence the necessary weakening of compile-time safety.</p>
<p>Now that we have covered the <em>body</em>, let's look at the bot's <em>soul</em>.</p>
<h3>the bot's soul</h3>
<p>Let us look at the setup of the Saga:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SomeSaga</span> <span class="token punctuation">:</span> <span class="token class-name">ICustomerSaga</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">IIntentRecognition</span> _intentRecognition<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SomeState</span> State <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token punctuation">[</span><span class="token class-name">UsedImplicitly</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token function">AddressChangeSaga</span><span class="token punctuation">(</span><span class="token class-name">IIntentRecognition</span> intentRecognition<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _intentRecognition <span class="token operator">=</span> intentRecognition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token class-name">OnDeserialized</span><span class="token punctuation">]</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">OnDeserialized</span><span class="token punctuation">(</span><span class="token class-name">StreamingContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _intentRecognition <span class="token operator">=</span> Conversation<span class="token punctuation">.</span>Container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Resolve</span><span class="token punctuation">&lt;</span><span class="token class-name">IIntentRecognition</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The deserialize hook is where things are ugly. The bot framework does not seem to use AutoFac to pull a bot state item
back into life, hence we cannot trust our dependencies to be correctly injected in this situation. That is where the deserialize hook comes into play and <em>"injects"</em> the dependencies into the Saga. Thankfully this doesn't cause much problems in testing since there we can create the Saga as usual through its constructor.</p>
<p>Finally, let us look into the Saga's Start method:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">string</span> input<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> intent <span class="token operator">=</span> <span class="token keyword">await</span> _intentRecognition<span class="token punctuation">.</span><span class="token function">FigureOutIntent</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> UserIntent<span class="token punctuation">.</span>Greeting<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PromptRespons</span>
                Prompt <span class="token operator">=</span> BotTexts<span class="token punctuation">.</span>GreetingText<span class="token punctuation">,</span> 
                Continuation <span class="token operator">=</span> <span class="token function">nameof</span><span class="token punctuation">(</span>Start<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> UserIntent<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PromptResponse</span> <span class="token punctuation">{</span> 
                Prompt <span class="token operator">=</span> BotTexts<span class="token punctuation">.</span>QuestionForNameText<span class="token punctuation">,</span> 
                Continuation <span class="token operator">=</span> <span class="token function">nameof</span><span class="token punctuation">(</span>FindCustomer<span class="token punctuation">)</span> 
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TerminateDialog</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> <span class="token string">"Woa, you got me there \U0001F937."</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you can see the <em>soul</em> of the dialog is now decoupled from the Dialog's mechanics. The <code class="language-text">nameof</code> helps us to alleviate the pain of necessary reflection by keeping refactoring support going and helping us pick the right method to continue to.</p>
<p>Where we still need to keep an eye on is that the type of the argument to the continuation matches the requirements, e.g. here, after a user has provided us with an address:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ProcessResponse<span class="token operator">></span> <span class="token function">AddressObtained</span><span class="token punctuation">(</span><span class="token class-name">Place</span> place<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">await</span> _someService<span class="token punctuation">.</span><span class="token function">UpdateAddress</span><span class="token punctuation">(</span>place<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TerminateDialog</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> BotTexts<span class="token punctuation">.</span>AddressUpdatedAndProcessFinishedText <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TerminateDialog</span> <span class="token punctuation">{</span> Text <span class="token operator">=</span> BotTexts<span class="token punctuation">.</span>FailedToStoreAddressText <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>It seems like quite a bit of work, considering that <code class="language-text">IDialog</code> implementations are indeed testable by virtue of all dependencies being interfaces. But consider this: A conversational interaction with a user will be full of branching, fallbacks, a lot of dispatching and state keeping. I am farily convinced that it makes sense to decouple conversation logic
from the bot infrastructure, because stuff will get <strong>complicated quite quickly</strong> and what better way to tame complexity than to separate concerns. </p></div><div class="article-pagination"><a class="article-pagination--previous" href="/2017/06/24/eleven-year-old-svg-engine-reposted">eleven year old svg engine, reposted</a><a class="article-pagination--next" href="/2017/07/02/amazing-morse-writing">Amazing morse writing</a></div></article></div></div></div></div></div><script>
  window.excludeGAPaths=[/^(?:\/404)$/];
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-1812710-1', 'auto', {});
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-article-template-js","jsonName":"2017-06-25-separating-ms-bots-soul-from-its-body-1ed","path":"/2017/06/25/separating-ms-bots-soul-from-its-body"};window.dataPath="773/path---2017-06-25-separating-ms-bots-soul-from-its-body-1-ed-b91-o6ECm2nYA20kn7Aor1hrYkdlVUg";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.a03716562d1e590f30ef.css","/app-6e0292f33bdbd16fe1a4.js"],"component---src-templates-article-template-js":["/component---src-templates-article-template-js-77b1cf90d2b01be70bbb.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-9d0c6a80f47992f50d17.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a750218f2f59bbc8c61a.js"],"component---src-pages-index-js":["/component---src-pages-index-js-30c7d9d265875c7dbd6d.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-6214e1d58749e3f52c87.js"]};/*]]>*/</script><script src="/webpack-runtime-82cffdf9266513af319a.js" async=""></script><script src="/app-6e0292f33bdbd16fe1a4.js" async=""></script><script src="/0-31cb8205322dc8b322a6.js" async=""></script><script src="/1-c5e48db84d3be9fa8158.js" async=""></script><script src="/component---src-templates-article-template-js-77b1cf90d2b01be70bbb.js" async=""></script></body></html>