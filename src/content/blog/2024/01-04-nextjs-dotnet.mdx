---
title: "Map next.js entry points to dotnet endpoints"
slug: nextjs-dotnet-entrypoints
tags: [csharp, dotnet, nextjs]
date: 2024-01-05 17:30:00
---

_From the documentation:_

In order to support the multiple entry points generated by next.js for the frontend build,
we __map the generated html files to a asp.net core route that will load exactly that file.__

Note that this is only done for release build, since in development we delegate frontend page requests 
to the __next.js dev server__.

For this, we need to "translate" the nomenclature of parameters in the route to parameters that __asp.net core__ understands. 
E.g. a folder called [id] inside "communities" that contains a post.html file will be mapped to /communities/\{id\}/post.
Under the route a request handler is registered that __loads the correct html file and serves it__

Extension to be called:

```csharp
public static void MapNextJsEntryPoints(
    this IEndpointRouteBuilder builder, 
    IHostEnvironment hostEnvironment)
{
	var nextJsEntryPoints = new NextJsEntryPointsProvider(hostEnvironment);
	foreach (var nextJsEntryPoint in nextJsEntryPoints)
	{
		builder
			.MapGet(
				nextJsEntryPoint.AspNetCoreRoute, 
				context => context.Response
                    .SendHtmlFileAsync(nextJsEntryPoint.AbsoluteFilePath))
			.RequireAuthorization(Permissions.UseAhead);
	}
}
...
private static async Task SendHtmlFileAsync(this HttpResponse response, string path)
{
	response.ContentType = "text/html";
	await response.SendFileAsync(path);
}

```

Here's the NextJsEntryPointsProvider

```csharp
public class NextJsEntryPointsProvider 
    : IEnumerable<NextJsEntryPointsProvider.IntermediatePath>
{
	private readonly IHostEnvironment currentEnvironment;
	private readonly List<IntermediatePath> htmlFiles;

	public NextJsEntryPointsProvider(IHostEnvironment currentEnvironment)
	{
		this.currentEnvironment = 
            currentEnvironment ?? throw new ArgumentNullException();
		htmlFiles = new List<IntermediatePath>();
		GetHtmlFiles(
            currentEnvironment.ContentRootFileProvider
                .GetDirectoryContents("wwwroot"));
	}

	private string WebRootPath => currentEnvironment.ContentRootPath;
	private IFileProvider FileProvider => currentEnvironment.ContentRootFileProvider;

	public IEnumerator<IntermediatePath> GetEnumerator() => htmlFiles.GetEnumerator();

	IEnumerator IEnumerable.GetEnumerator()
	{
		return GetEnumerator();
	}

	private void GetHtmlFiles(
		IDirectoryContents contents,
		IntermediatePath? parent = null)
	{
		foreach (var item in contents)
		{
			switch (item)
			{
				case {IsDirectory: false, Name: "index.html" } when parent == null:
					// index.html is handled by the HomeController/Index controller action.
					continue;
				case {
                    IsDirectory: true, 
                    Name: 
                        NextJsFolder
                        or PeopleProfileDefinitionFolder 
                        or ImagesFolder 
                        or DistFolder}:
					// These folders do not contain any entry points.
					continue;
				case {IsDirectory: true}:
					var newParent = new IntermediatePath(
                        parent, WebRootPath, item.Name);
					GetHtmlFiles(
                        FileProvider.GetDirectoryContents(newParent.ProviderFilePath), 
                        newParent);
					break;
				case {IsDirectory: false} when item.Name.EndsWith(".html"):
					htmlFiles.Add(
                        new IntermediatePath(parent, WebRootPath, item.Name));
					break;
			}
		}
	}

	// IntermediatePath is a nested class of this one
}
```

`ContentRootFileProvider` is of Type `IFileProvider`.

```csharp
public readonly struct IntermediatePath
{
    public IntermediatePath(IntermediatePath? parent, string root, string filePath)
    {
        AspNetCoreRoute = Routify(parent, filePath);
        ProviderFilePath = parent != null ? Path.Combine(
            parent.Value.ProviderFilePath, filePath) : 
            Path.Combine("wwwroot", filePath);
        AbsoluteFilePath = Path.Combine(root, ProviderFilePath);
    }

    public string ProviderFilePath { get; }
    public string AbsoluteFilePath { get; }
    public string AspNetCoreRoute { get; }

    private static string Routify(
        IntermediatePath? intermediatePath, 
        string fileName) =>
        (intermediatePath.HasValue ? 
            $"{intermediatePath.Value.AspNetCoreRoute}/" : string.Empty + 
            fileName
                .Replace(".html", string.Empty)
                .Replace("[", "{")
                .Replace("]", "}");
}
```
