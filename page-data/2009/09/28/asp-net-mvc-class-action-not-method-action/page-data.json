{"componentChunkName":"component---src-templates-article-template-js","path":"/2009/09/28/asp-net-mvc-class-action-not-method-action","result":{"data":{"markdownRemark":{"html":"<p>While pushing along my little home-brew CMS, Rf.Sites, which uses ASP.NET MVC for the HTTP Cruft that comes with Web development, there was something that was disturbing me. The train of thought was roughly as follows:</p>\n<ol>\n<li>Hm, when I show content by id (URL e.g. Content/Entry/1), I may have other dependencies than some other Content request.</li>\n<li>Since both methods may live in the same controller I may inject dependencies that may not be used for the current request. That's kinda silly. Construction is not that expensive, but it's sort of awkward because I only call one method / controller instantiation...\nIs it service location for lazy loading of dependencies then? Fair enough, but testing the controller means to provide an IContainer.</li>\n<li>In my current work project that uses WinForms we have a pretty clear map of class (Command) / user interaction. I do like that...can't we have that in ASP.NET MVC as well?</li>\n<li>Think...more think. Isn't the ASP.NET MVC source code available? What does MVC actually do to call the Controller method when I use a certain URL?</li>\n</ol>\n<p>First off: Having source code available for MVC is terrific. Best documentation there is. It seems to me that the developers have made an effort to provide decent code. I.e. understandable, a little bit of duct tape, and abstractions where you might expect them. You can agree or disagree with decisions taken for that framework, but code availability and a clean layout are really major selling points in my eyes.</p>\n<p>In the MVC source code I found the notion of the <em>Action Invoker</em>. This is the code responsible for calling the appropriate action for an incoming request. The Controller class already has a way in place to exchange the Action Invoker. To trigger it, I need to do this:\n<code class=\"language-text\">public class ActionDispatcher : Controller\n{\n  public ActionDispatcher(IActionInvoker invoker)\n  {\n    ActionInvoker = invoker;\n  }\n}</code></p>\n<p>How this controller can be instantiated has already been <a href=\"http://haacked.com/archive/2007/12/07/tdd-and-dependency-injection-with-asp.net-mvc.aspx\">explained here</a></p>\n<p>In my DI container of choice, I then register what IActionInvoker is:</p>\n<p><code class=\"language-text\">ForRequestedType&lt;IActionInvoker&gt;()\n  .TheDefaultIsConcreteType&lt;UrlToClassActionInvoker&gt;();</code></p>\n<p>How does said action invoker look like? Here's the main method:</p>\n<p>`\npublic bool InvokeAction(\nControllerContext controllerContext,\nstring actionName)\n{\nstring instanceKey = formTheName(controllerContext);</p>\n<p>  var action = container.With(controllerContext)\n.GetInstance<IAction>(instanceKey);\nvar result = action.Execute();\nresult.ExecuteResult(controllerContext);\nreturn true;\n}\n`</p>\n<p><em>IAction</em> is my own abstraction and looks like that:</p>\n<p><code class=\"language-text\">public interface IAction\n{\n  ActionResult Execute();\n}</code></p>\n<p>The <em>instanceKey</em> essentially concatenates the request such that Content/Entry becomes ContentEntry.</p>\n<p>What is needed now is to register all <em>IAction</em> implementations based on said convention...</p>\n<p><code class=\"language-text\">Scan(\n  s =&gt;\n  {\n    s.AssemblyContainingType&lt;SiteRegistry&gt;();\n    s.AddAllTypesOf&lt;IAction&gt;()\n      .NameBy(t =&gt; t.Name.Replace(&quot;Action&quot;, &quot;&quot;));\n  });</code></p>\n<p>Now, if I want to handle a call to <em>Entry</em> under <em>Content</em>, I specify\nan Action called <em>ContentEntryAction</em>.</p>\n<p>Arguments to those actions are encapsulated as concrete classes. Since the <em>ControllerContext</em> is provided to StructureMap when obtaining an <em>IAction</em> instance, any class can express a dependency to this concrete instance and obtain the one added for this specific instance resolution. Since the Arguments class is also a concrete class, there is no need to explicitly register those in StructureMap. I have e.g. these Arguments...\n`\npublic class RequestByIDActionArgs\n{\npublic RequestByIDActionArgs() { }</p>\n<p>  public RequestByIDActionArgs(ControllerContext ctx)\n{\nvar routeDataValues = ctx.RouteData.Values;\nId = int.Parse(routeDataValues[\"val1\"].ToString());\n}</p>\n<p>  public int Id { get; set; }\n}\n`\nWhich are then fed to the action through the constructor:</p>\n<p>`\npublic class ContentEntryAction : AbstractAction\n{\nprivate readonly RequestByIDActionArgs args;\nprivate readonly IRepository<Content> repository;</p>\n<p>  public ContentEntryAction(\nRequestByIDActionArgs args,\nIRepository<Content> repository)\n{\nthis.args = args;\nthis.repository = repository;\n}</p>\n<p>  public override ActionResult Execute()\n{\nvar content = repository[args.Id];\nreturn createResult(new ContentViewModel(content));\n}\n}\n`</p>\n<p>I am aware that for now I've cut myself off from all features that come into MVC through the ActionInvoker abstraction. As far as I can understand the code this is the handling of all those cutesy filters, authorizations and similar attributes with which you can decorate your controller methods. I'll see how to reintroduce them once I need it. </p>\n<p>For now I am happy that I was able to introduce a class / action pattern without much effort - I don't have a \"controllers\" folder in my MVC project anymore, instead I have an \"actions\" folder.</p>","fields":{"slug":"/2009/09/28/asp-net-mvc-class-action-not-method-action"},"frontmatter":{"date":"September 28, 2009","path":null,"title":"ASP.NET MVC: class / action, not method / action","tags":["patterns","libs-and-frameworks","csharp"]}}},"pageContext":{"title":"ASP.NET MVC: class / action, not method / action","previous":{"fields":{"slug":"/2009/09/25/how-can-i-get-rid-of-this-goto","published":true},"frontmatter":{"title":"How can I get rid of this goto?","tags":["software-development","csharp"],"date":"2009/09/24"}},"next":{"fields":{"slug":"/2009/10/14/rf-sites-source-code-available","published":true},"frontmatter":{"title":"Rf.Sites source code available","tags":["software-development","own-software","web","libs-and-frameworks"],"date":"2009/10/14"}}}}}