{"componentChunkName":"component---src-templates-article-template-js","path":"/2010/09/08/membus-performance-considerations","result":{"data":{"markdownRemark":{"html":"<p>When developing a piece of code that could potentially be used as a central component, one should have a look at the performance as well. There is no easy answer as to whether MemBus is fast or not – it depends which features you are using.</p>\n<p>I have been doing a number of performance measurements wit the following setup:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TextWriter</span> w<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    bus<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Subscribe</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MessageA<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>onMessageA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    bus<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Subscribe</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MessageB<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>onMessageB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    bus<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Subscribe</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MessageC<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>onMessageC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> r <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> dict <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">object</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span>\n                   <span class=\"token punctuation\">{</span>\n                       <span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MessageA</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                       <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MessageB</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                       <span class=\"token punctuation\">{</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">MessageC</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> sw <span class=\"token operator\">=</span> Stopwatch<span class=\"token punctuation\">.</span><span class=\"token function\">StartNew</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        bus<span class=\"token punctuation\">.</span><span class=\"token function\">Publish</span><span class=\"token punctuation\">(</span>dict<span class=\"token punctuation\">[</span>r<span class=\"token punctuation\">.</span><span class=\"token function\">Next</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    w<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Through {0}\"</span><span class=\"token punctuation\">,</span> sw<span class=\"token punctuation\">.</span>ElapsedMilliseconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        w<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"From MsgA:{0}({1}), B:{2}({3}), C:{4}({5})\"</span><span class=\"token punctuation\">,</span> aCount<span class=\"token punctuation\">,</span> MessageA<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">,</span> bCount<span class=\"token punctuation\">,</span>\n                    MessageB<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">,</span> cCount<span class=\"token punctuation\">,</span> MessageC<span class=\"token punctuation\">.</span>Count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Thread<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        count<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The actual publishing happens in line 18. We publish three different messages by random, in total 100’000 messages. The three subscriptions each increment a counter, the messages themselves increment an internal counter when they are constructed. Let’s start with the simple setup (“<strong>Conservative</strong>”):</p>\n<p><img src=\"/assets/image_5314e329-cdb9-4cdc-82d8-2245ebc72749.png\" alt=\"image\" title=\"image\"> </p>\n<p>Pretty quick. Let’s compare it to the “<strong>AsyncConfiguration</strong>”:</p>\n<p><img src=\"/assets/image_e3e558bc-b06e-4827-bf63-59863e4ff134.png\" alt=\"image\" title=\"image\"> </p>\n<p>That’s taking a while...Let us actually do some work in a subscription and put a small thread.sleep() of 1 milliseconds in the subscription of message B. Let’s go <strong>Conservative</strong>:</p>\n<p><img src=\"/assets/image_26fb2203-0e83-4070-a1b7-93ac4c8c9dab.png\" alt=\"image\" title=\"image\"> </p>\n<p>That could be expected! B got 33463 messages, at 1ms each it gives you roughly that number. Let’s push it through the <strong>AsyncConfiguration</strong>:</p>\n<p><img src=\"/assets/image_4f1ee625-b549-4ff8-933f-35ee48eb3165.png\" alt=\"image\" title=\"image\"> </p>\n<p>The Publishing loop comes back much quicker, but now we can see that the work hasn’t been completed yet – The message construction count differs from the subscription counters! Also note that in this scenario I had to change the Increment code (“<strong>++</strong>”) to the thread-safe version (“<strong>Interlocked.Increment(ref i)</strong>”) as the counts would not match up anymore. As opposed to the code shown, I changed the counter output to be delayed by 1 seconds. Hence, after roughly 9 seconds all work was done.</p>\n<p>As a final check, let’s use the “<strong>Fast</strong>” setup:</p>\n<p><img src=\"/assets/image_7519dc98-15d1-439f-aa9f-1ac3a30d139a.png\" alt=\"image\" title=\"image\"> </p>\n<p>Here, publishing comes back pretty quick, but the work also takes about the same time. the Fast setup was created after some sessions with the dotTrace performance profiler that showed where time could be saved. The fast setup will not do <strong>contravariant publishing</strong> (i.e. a subscription on a message of type object will not receive a message of type “MessageA”) and exceptions in subscriptions are <strong>not taken care of</strong>.</p>\n<p>As usual, answering performance related issues isn’t easy. It very much depends on the circumstances, what kind of setup you should take, how much work subscriptions do, how many messages are sent, etc., etc.</p>","fields":{"slug":"/2010/09/08/membus-performance-considerations"},"frontmatter":{"date":"September 08, 2010","path":null,"title":"Membus: Performance considerations","tags":["software-development","patterns","csharp","membus"]}}},"pageContext":{"title":"Membus: Performance considerations","previous":{"fields":{"slug":"/2010/09/06/membus-a-more-complex-rich-client-setup","published":true},"frontmatter":{"title":"MemBus: A more complex rich client setup","tags":["software-development","dotnet","patterns","membus"],"date":"2010/09/06"}},"next":{"fields":{"slug":"/2010/09/15/using-membus","published":true},"frontmatter":{"title":"Using MemBus","tags":["patterns","csharp","membus"],"date":"2010/09/15"}}}}}