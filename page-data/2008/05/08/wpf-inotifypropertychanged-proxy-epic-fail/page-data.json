{"componentChunkName":"component---src-templates-article-template-js","path":"/2008/05/08/wpf-inotifypropertychanged-proxy-epic-fail","result":{"data":{"markdownRemark":{"html":"<p>It seemed a straightforward thing to do.</p>\n<p>Sending property changed events when a property is changed is repetitive boilerplate code that can be factored out into an aspect of your system's behaviour. This can be done with a proxy generator library like the Castle's **DynamicProxy2 **(See my first attempts playing with such a framework <a href=\"http://realfiction.net/go/154\">here</a>).</p>\n<p>The idea goes as follows: Program an <strong>IInterceptor</strong> that every time a setter of the class encapsulated by the proxy is accessed raises the <strong>PropertyChanged</strong> event as defined by the interface mentioned in the title. The basic problem is that accessing a property from the outside is OK: But what if you change the property from the inside? A basic proxy that simply surrounds the class cannot register this action, hence no event is automatically raised...</p>\n<p>The idea grew: Implement a class that is abstract. All properties defined on it are marked abstract. Then use DynamicProxy2 in the provided way that generates a proxy that inherits from your abstract class and in fact appears to \"implement\" the properties defined in the class. I am using quotes here, because there seems to be no implementation of the abstract properties available even once the proxy has been generated - don't ask me, I'll have to dig for details in the appropriate forum.</p>\n<p>However, the Interceptor registers when the setter of such a property is accessed. Provided you do not \"Proceed\" to an underlying implementation (that may not exist), you can provide an implementation of the property within the Interceptor itself. This is quite easy and in my case I just based it on a Dictionary:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span><span class=\"token punctuation\">></span></span> values <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Dictionary<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">object</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Intercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IInvocation</span> invocation<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> talkingToPropertySetter <span class=\"token operator\">=</span> \n    invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">.</span>IsSpecialName <span class=\"token operator\">&amp;&amp;</span> \n    invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">.</span><span class=\"token function\">StartsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set_\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> talkingToPropertyGetter <span class=\"token operator\">=</span> <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>talkingToPropertyGetter<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> output<span class=\"token punctuation\">;</span>\n        values<span class=\"token punctuation\">.</span><span class=\"token function\">TryGetValue</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetPropertyName</span><span class=\"token punctuation\">(</span>invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">out</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        invocation<span class=\"token punctuation\">.</span>ReturnValue <span class=\"token operator\">=</span> output<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>talkingToPropertySetter<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        values<span class=\"token punctuation\">[</span><span class=\"token function\">GetPropertyName</span><span class=\"token punctuation\">(</span>invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> invocation<span class=\"token punctuation\">.</span>Arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">RaisePropertyChangedEvent</span><span class=\"token punctuation\">(</span>invocation<span class=\"token punctuation\">.</span>InvocationTarget<span class=\"token punctuation\">,</span>\n        <span class=\"token function\">GetPropertyName</span><span class=\"token punctuation\">(</span>invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>You can also already see how the interceptor raises the event. Indeed, the abstract class does not event need to implement the INotifyPropertyChanged interface: We can say that our proxy should implement it and simply ensure that our interceptor implements the mechanics:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">PropertyInterceptor</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IInterceptor</span></span>\n<span class=\"token punctuation\">{</span>\n<span class=\"token class-name\">PropertyChangedEventHandler</span> handler<span class=\"token punctuation\">;</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Intercept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IInvocation</span> invocation<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">bool</span></span> talkingToAddChangedEventHandler <span class=\"token operator\">=</span> \n        invocation<span class=\"token punctuation\">.</span>Method<span class=\"token punctuation\">.</span>Name <span class=\"token operator\">==</span> <span class=\"token string\">\"add_PropertyChanged\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>talkingToAddChangedEventHandler<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            handler <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>PropertyChangedEventHandler<span class=\"token punctuation\">)</span>invocation<span class=\"token punctuation\">.</span>Arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">RaisePropertyChangedEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">object</span></span> o<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> notifiedProperty<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handler <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PropertyChangedEventArgs</span><span class=\"token punctuation\">(</span>notifiedProperty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The attached solution shows the full implementation of the prototype. Basically, it works. This play-class behaves as a fully fledged class implementing INotifyPropertyChanged and raising events like the big kids do:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Person</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> FirstName <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token return-type class-name\">DateTime</span> Birthdate <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">virtual</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Promote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>FirstName <span class=\"token operator\">=</span> FirstName <span class=\"token operator\">+</span> <span class=\"token string\">\" The Chief\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And then to get the proxy:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\">Person</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotifyingGenerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Create</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Person<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>INotifyPropertyChanged<span class=\"token punctuation\">)</span>p2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>PropertyChanged <span class=\"token operator\">+=</span> \n    <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">PropertyChangedEventHandler</span><span class=\"token punctuation\">(</span>p2_PropertyChanged<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Great! On to WPF. After all, one of the main uses of such a such a class would be to bind it to some WPF UI. Here is were things go very awry.</p>\n<p>Basically, WPF needs to do reflection as well to perform the binding magic. This, however, seems to bite badly with how the proxy is generated. With a proxy like the above we very quickly get a XamlParseException due to an <a href=\"http://msdn.microsoft.com/en-us/library/system.reflection.ambiguousmatchexception.aspx\">AmbiguousMatchException</a>.</p>\n<p><strong>Unfortunate!</strong></p>\n<p>My second attempt was to make the abstract properties on Person protected, provide a public interface with equally named properties, let the proxy implement the interface on the fly, and bind all this to the WPF. Now WPF would not throw an error, but the whole implementation fails: No properties can be read, the interceptor is not invoked. WPF's reflection goes to some other place where no proxy has gone before.</p>\n<p>Epic fails are quite normal for a first shot, but looks like we need to stick to boilerplate code for now...</p>\n<p>The VS2008 solution contains both attempts, you can check for yourself. Maybe there is a solution to the issue after all. If time permits I will do some manual reflection on the proxy to try and get an AmbiguousMatchException myself, which should guide to a possible solution if there is any.</p>","fields":{"slug":"/2008/05/08/wpf-inotifypropertychanged-proxy-epic-fail"},"frontmatter":{"date":"May 08, 2008","path":null,"title":"WPF + INotifyPropertyChanged Proxy = Epic Fail!","tags":["download","dotnet","libs-and-frameworks","WPF"]}}},"pageContext":{"title":"WPF + INotifyPropertyChanged Proxy = Epic Fail!","previous":{"fields":{"slug":"/2008/05/04/is-it-alright-to-send-messages-to-null-references","published":true},"frontmatter":{"title":"Is it alright to send messages to null references?","tags":["software-development","dotnet","patterns"],"date":"2008/05/04"}},"next":{"fields":{"slug":"/2008/05/13/lazy-instantiation-one-liner-of-instance-fields-with-the-coalesce-operator","published":true},"frontmatter":{"title":"Lazy instantiation one-liner of instance fields with the coalesce operator","tags":["software-development","dotnet"],"date":"2008/05/13"}}}}}