{"componentChunkName":"component---src-templates-article-template-js","path":"/2008/09/23/nhibernates-isession-scoped-for-a-single-wcf-call","result":{"data":{"markdownRemark":{"html":"<p>I am working at a project that uses the .NET 3.5 communication stack between client &#x26; server (WCF) and they have decided to be Domain driven. In this case NHibernate (NH) is the persistence framework of choice.</p>\n<p>The abstraction chosen for persistence are repositories (See Evans' relevatory book \"Domain-Driven Design: Tackling Complexity in the Heart of Software\").</p>\n<p>When you look at NH's architecture, you will find the thread-safe Session Factory and the thread affine Session. A repository will need a session to operate against the underlying Database. According to <a href=\"http://ayende.com/Blog/archive/2008/07/24/How-to-review-NHibernate-application.aspx\">Ayende</a>, there are a number of bad patterns surrounding NH usage, one of which is starting a NH session per Repository, or even worse one Session per Repository call. For once, you are unable to do a transaction spanning several repositories. There, that should be enough as deterrence.</p>\n<p>What scope to choose then for the session and how can we ensure the correct scope of a Session?</p>\n<p>I am certainly not the first one to write about this, only recently Jimmy Bogard blogged about \"<a href=\"http://www.lostechies.com/blogs/jimmy_bogard/archive/2008/09/16/integrating-structuremap-and-nhibernate-with-wcf.aspx\">Integrating StructureMap and NHibernate with WCF</a>\"</p>\n<p>So, why do I write about it again? Because there aren't enough good practice posts surrounding NHibernate, and that way I can contribute to that matter.</p>\n<p>I chose a slightly different route...I stated to my Customer that we will have WCF services that work <strong>per call</strong>. It means that:</p>\n<ul>\n<li>There is no Session (That is, some sort of client session)</li>\n<li>A service implementation is created and destroyed for every call</li>\n<li>The scope of a service instance is the same as the scope of a request is the same as the scope we chose for the NHibernate Session.</li>\n</ul>\n<p>Those assumptions allow you to simplify the procedure somewhat. Since we already use a Custom Instance Provider in order to do Dependency Injection at the service level, that Custom Instance Provider is the perfect place to set things up for a NH Session per call. Let us look at the Instance Provider:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceInstanceProvider<span class=\"token punctuation\">&lt;</span>CONTRACT<span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IInstanceProvider</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">GetInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InstanceContext</span> instanceContext<span class=\"token punctuation\">,</span> <span class=\"token class-name\">System<span class=\"token punctuation\">.</span>ServiceModel<span class=\"token punctuation\">.</span>Channels<span class=\"token punctuation\">.</span>Message</span> message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> nhSessMgrExtension <span class=\"token operator\">=</span> instanceContext<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Find</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NHibernateContextManager<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nhSessMgrExtension <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      instanceContext<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NHibernateContextManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> kernel<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Get</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CONTRACT<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Ninject Kernel in this case, but irrelevant for this post</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ReleaseInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System<span class=\"token punctuation\">.</span>ServiceModel<span class=\"token punctuation\">.</span>InstanceContext</span> instanceContext<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> instance<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> nhSessMgrExtension <span class=\"token operator\">=</span> instanceContext<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Find</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NHibernateContextManager<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nhSessMgrExtension <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      instanceContext<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span><span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span>nhSessMgrExtension<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Strictly speaking, we have a Session / service instance, however, see the above assumptions.</p>\n<p>What is used here is one of the several contexts that WCF provides, Off hand you will see the OperationContext, InstanceContext as well as a RequestContext. Since technically I am scoping the NH Session to an instance, I will make an Extension to the InstanceContext with the provided Extension Mechanism (\"<strong>Extensions.Add(...)</strong>\").\nLet us have a look at that NHContextManager:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">NHibernateContextManager</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IExtension<span class=\"token punctuation\">&lt;</span>InstanceContext<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">ISession</span> Session <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Attach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InstanceContext</span> owner<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//We have been attached to the Current operation context from the </span>\n    <span class=\"token comment\">// ServiceInstanceProvider</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Detach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">InstanceContext</span> owner<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Session <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n      Session<span class=\"token punctuation\">.</span><span class=\"token function\">Flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Session<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Attach/Detach need to be implemented by contract. They are called when your extension is added / removed to the Extensions list.</p>\n<p>The only thing left in the puzzle is to ensure proper session instantiation and reuse. Let us delegate this to a bit of infrastructure that NHibernate provides to us. We can register a class in the NH configuration that does the job of determining a Session when somebody calls sessionFactory.GetCurrentSession().</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> currentSessionContextImplTypeName <span class=\"token operator\">=</span> \n  <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">NHWCFSessionContext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>FullName <span class=\"token operator\">+</span> <span class=\"token string\">\", \"</span> <span class=\"token operator\">+</span> \n  <span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">NHWCFSessionContext</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Assembly<span class=\"token punctuation\">.</span>FullName<span class=\"token punctuation\">;</span>\nprops<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"current_session_context_class\"</span><span class=\"token punctuation\">,</span> currentSessionContextImplTypeName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> cfg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NHibernate<span class=\"token punctuation\">.</span>Cfg<span class=\"token punctuation\">.</span>Configuration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AddProperties</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\nsessionFactory <span class=\"token operator\">=</span> cfg<span class=\"token punctuation\">.</span><span class=\"token function\">BuildSessionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>That class we register here needs to implement an interface and provide a constructor to which the sessionFactory will be passed. Now we can pull the bits together:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NHWCFSessionContext</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ICurrentSessionContext</span></span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">NHWCFSessionContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ISessionFactory</span> factory<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>factory <span class=\"token operator\">=</span> factory<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">NHibernate<span class=\"token punctuation\">.</span>ISession</span> <span class=\"token function\">CurrentSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Get the WCF InstanceContext:</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> contextManager <span class=\"token operator\">=</span> OperationContext<span class=\"token punctuation\">.</span>Current\n      <span class=\"token punctuation\">.</span>InstanceContext<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Find</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NHibernateContextManager<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>contextManager <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">InvalidOperationException</span><span class=\"token punctuation\">(</span>\n<span class=\"token string\">@\"There is no context manager available. \nCheck whether the NHibernateContextManager is added as InstanceContext extension. \nAlso, this Session Provider only makes sense in a WCF context.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>contextManager<span class=\"token punctuation\">.</span>Session <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n      contextManager<span class=\"token punctuation\">.</span>Session <span class=\"token operator\">=</span> factory<span class=\"token punctuation\">.</span><span class=\"token function\">OpenSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> contextManager<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That is pretty much it. If you have a DI container in use you can now add the bonus of registering some kind of instance provider for the ISession interface. In Ninject this would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">m<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Bind</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NHibernate<span class=\"token punctuation\">.</span>ISession<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">ToProvider</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>NHSessionProvider<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>And the SessionProvider does nothing but say:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">return</span> sessionFactory<span class=\"token punctuation\">.</span><span class=\"token function\">GetCurrentSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you now instantiate a repository from the DI Container, and that repository has a dependency to ISession, it will get the Session correctly scoped for your WCF call.</p>\n<p>A last disclaimer. The lifetime of services and such in WCF is not trivial. There are numerous options and depending on your target application the choices made here may not be your choices and the answer how your NH Session should be scoped is possibly not obvious either. But I hope that with the links provided and the info in here you can do a well-grounded choice.</p>","fields":{"slug":"/2008/09/23/nhibernates-isession-scoped-for-a-single-wcf-call"},"frontmatter":{"date":"September 23, 2008","path":null,"title":"NHibernate's ISession, scoped for a single WCF-call","tags":["libs-and-frameworks","dotnet"]}}},"pageContext":{"title":"NHibernate's ISession, scoped for a single WCF-call","previous":{"fields":{"slug":"/2008/09/07/spoiled-with-dependency-injection","published":true},"frontmatter":{"title":"Spoiled with Dependency Injection","tags":["dotnet","patterns"],"date":"2008/09/07"}},"next":{"fields":{"slug":"/2008/10/18/update-to-drupal6-commenting-disabled","published":true},"frontmatter":{"title":"Update to Drupal6 - Commenting disabled","tags":["meta"],"date":"2008/10/18"}}}}}