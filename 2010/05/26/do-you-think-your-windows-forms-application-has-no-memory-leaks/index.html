<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.6c827614bcd63144d6db.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! normalize.css v3.0.2 | MIT License | git.io/normalize */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}:root{--linkColorMain:#af0000;--linkColorMainContrast:#c6f8ff;--linkColor:#1eaedb;--linkHoverHighlight:#fff 0px 0px 5px,#7791b3 0px 0px 10px;--background:#fff;--sidePadding:0.75rem;--topShadow:0px 5px 7px 0px rgba(0,0,0,0.55);--lightSeparator:1px solid #d3d3d3;--standardShadow:0 8px 16px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19)}body{font-size:1.5em;line-height:1.6;font-weight:400;font-family:Raleway,HelveticaNeue,Helvetica Neue,Helvetica,Arial,sans-serif;padding:0 var(--sidePadding) 0 var(--sidePadding)}a{color:var(--linkColor)}figcaption{text-align:center;font-style:italic;color:#777;display:block;margin-bottom:2em}img{display:block;margin:20px auto;max-width:100%;box-shadow:var(--standardShadow)}blockquote{background:#f9f9f9;border-left:10px solid #ccc;padding:.5rem 10px;quotes:"\201C""\201D""\2018""\2019"}blockquote:before{color:#ccc;content:"\201D";font-size:4em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}h1{font-size:2.1rem}h1,h2{line-height:1.2}h2{font-size:1.7rem}h3{line-height:1.2;letter-spacing:.05rem}h3,h4{font-size:1.5rem}h4{font-weight:lighter;font-style:italic}@media (min-width:768px){h1{font-size:2.5rem}h1,h2{line-height:1.3}h2{font-size:2rem}h3{line-height:1.1}h3,h4{font-size:1.7rem}}.layout-module--layout--3NElS{display:flex;flex-direction:column;align-items:center}.layout-module--main--1XJsu{padding:5rem 0 1rem;width:100%}@media (min-width:768px){.layout-module--main--1XJsu{width:90%}}@media (min-width:1200px){.layout-module--main--1XJsu{width:70%}}@media (min-width:2300px){.layout-module--main--1XJsu{width:55%}}.SiteHeader-module--siteNav--3VakG{display:flex;align-items:stretch;justify-content:center;padding:.5rem var(--sidePadding);box-shadow:var(--topShadow);background-color:var(--background);z-index:10;position:fixed;top:0;right:0;left:0}.SiteHeader-module--main--uZpGc{display:flex;flex-direction:row;justify-content:space-between;align-items:center;width:100%}.SiteHeader-module--siteHeader--3gDoz{font-family:Lora,serif;font-style:italic;letter-spacing:.01rem;text-shadow:2px 1px 1px #999;margin:0 1rem 0 0;font-size:2.2rem}.SiteHeader-module--mainLink---Exlm,.SiteHeader-module--siteLink--1QNau{text-decoration:none;display:inline-block}.SiteHeader-module--mainLink---Exlm:hover,.SiteHeader-module--siteLink--1QNau:hover{text-decoration:underline}.SiteHeader-module--mainLink---Exlm,.SiteHeader-module--mainLink---Exlm:visited,.SiteHeader-module--siteLink--1QNau,.SiteHeader-module--siteLink--1QNau:visited{color:var(--linkColorMain)}.SiteHeader-module--siteLink--1QNau:not(:first-child):before{content:" | ";color:#000;margin:0 .25rem;text-decoration:none;display:inline-block}@media (min-width:768px){.SiteHeader-module--main--uZpGc{width:90%}}@media (min-width:1200px){.SiteHeader-module--main--uZpGc{width:70%}}@media (min-width:2300px){.SiteHeader-module--main--uZpGc{width:55%}}.Footer-module--main--1QC0I{width:100%;display:flex;flex-direction:row;padding-top:.5rem;margin-bottom:2rem;justify-content:center;align-items:center;font-size:1rem;border-top:var(--lightSeparator)}.Footer-module--main--1QC0I img{margin:.25rem;box-shadow:none}.Footer-module--main--1QC0I p{margin:.25rem}@media (min-width:768px){.Footer-module--main--1QC0I{width:90%}}@media (min-width:1200px){.Footer-module--main--1QC0I{width:70%}}@media (min-width:2300px){.Footer-module--main--1QC0I{width:55%}}.tags-module--columnList--2IU2r{display:grid;list-style:circle inside;grid-auto-flow:row;grid-template-columns:repeat(auto-fill,300px);max-width:100%;font-size:1.2rem}.tags-module--columnList--2IU2r a{text-decoration:none}.tags-module--columnList--2IU2r a:hover{text-decoration:underline}.Tag-module--tags--3UNk1{margin-top:.5rem}.Tag-module--tag--3otWA{background-color:var(--linkColor);color:var(--linkColorMainContrast);text-decoration:none;font-size:1.1rem;margin-top:0;padding:.25rem}.Tag-module--tag--3otWA,.Tag-module--tagOuter--27OmX{border-top-right-radius:10px;border-bottom-right-radius:10px;border-top-left-radius:5px;border-bottom-left-radius:5px}.Tag-module--tagOuter--27OmX{display:inline-flex;margin:0 .5rem .5rem 0;padding:0;line-height:1.1rem;box-shadow:5px 5px 8px -8px rgba(0,0,0,.91)}.Tag-module--tagOuter--27OmX:hover{text-shadow:var(--linkHoverHighlight)}.Tag-module--tag--3otWA:after{margin-left:.75rem;font-size:1.5rem;vertical-align:middle;content:"•"}.YouTubeEmbed-module--frame--JPpxk{display:block;margin:20px auto;width:516px;height:315px;max-width:100%;box-shadow:var(--standardShadow)}.Info-module--infoContainer--1O0oR,.Tweet-module--tweet--1nwF8{display:flex;justify-content:center}.Info-module--info--1Qfs3{background:#c6f8ff;border-left:10px solid var(--linkColor);padding:1rem .25rem;margin-bottom:2.5rem;box-shadow:var(--standardShadow);width:95%;quotes:"\201C""\201D""\2018""\2019"}div.Info-module--info--1Qfs3:before{color:var(--linkColor);content:"\24D8";font-size:2em;font-family:helvetica;line-height:.1em;margin-right:.25em;vertical-align:-.4em}@media (min-width:768px){.Info-module--info--1Qfs3{width:80%}}@media (min-width:1200px){.Info-module--info--1Qfs3{width:70%}}.DateDisplay-module--dateContainer--1trkw{align-self:flex-start;display:inline-grid;grid-template-columns:0 auto;grid-template-rows:auto auto;border:1px solid var(--linkColorMain);border-radius:5px}.DateDisplay-module--month--2KOka{font-size:1rem;line-height:1rem;text-align:center;padding:.25rem .5rem;display:block;grid-column:2;grid-row:1}.DateDisplay-module--date--oZxQz{display:flex;grid-column:2;grid-row:2;background-color:var(--linkColorMain);color:#fff;padding:.25rem 0;font-size:1.2rem;line-height:1.2rem;text-align:center;justify-self:stretch;justify-content:center;align-items:center}.DateDisplay-module--year--2577t{display:block;visibility:hidden;-ms-writing-mode:tb-lr;writing-mode:vertical-lr;grid-column:1;grid-row:1/span 2;padding:.25rem;line-height:1rem}.DateDisplay-module--excerpt--ac7UJ{font-size:1.4rem;margin:.25rem}@media (min-width:500px){.DateDisplay-module--dateContainer--1trkw{grid-template-columns:1.5rem 3rem}.DateDisplay-module--year--2577t{visibility:visible}}.postExcerpt-module--article--1YC-H{margin-bottom:3rem}.postExcerpt-module--article--1YC-H:last-of-type{margin-bottom:0}.postExcerpt-module--headerContainer--hcRy6{display:flex;flex-direction:row;align-items:center}.postExcerpt-module--header--1LVL4{font-size:1.7rem;line-height:2rem;margin:0 0 0 .5rem}.postExcerpt-module--header--1LVL4 a{text-decoration:none}.postExcerpt-module--header--1LVL4 a:hover{text-decoration:underline}.postExcerpt-module--dateContainer--3lfoy{align-self:flex-start;display:inline-grid;grid-template-columns:auto auto;grid-template-rows:auto auto;border:1px solid var(--linkColorMain);border-radius:5px}.postExcerpt-module--month--59SAH{font-size:1rem;line-height:1rem;text-align:center;padding:.25rem .5rem;display:block;grid-column:2;grid-row:1}.postExcerpt-module--date--2LGbD{display:block;grid-column:2;grid-row:2;background-color:var(--linkColorMain);color:#fff;padding:.25rem 0;font-size:1.2rem;line-height:1.2rem;text-align:center;justify-self:stretch}.postExcerpt-module--year--w1z16{display:block;-ms-writing-mode:tb-lr;writing-mode:vertical-lr;grid-column:1;grid-row:1/span 2;padding:.25rem;line-height:1rem}.postExcerpt-module--excerpt--2vlk7{font-size:1.4rem;margin:.25rem}.TopicToc-module--container--iTCNh{border-radius:25px;background:#f9f9f9;box-shadow:var(--standardShadow)}.TopicToc-module--header--23y04{text-align:right;border-top-left-radius:25px;border-top-right-radius:25px;font-size:1.2em;background-color:#777;color:#fff;margin-bottom:0;padding:2px 20px 2px 0;font-style:italic}.TopicToc-module--list--d3sjU{list-style-type:upper-roman;margin:1rem;padding-bottom:1rem;list-style-position:outside}.Discussion-module--alpha--2wwoE{margin-right:20%}.Discussion-module--beta--280lX{margin-left:20%}.Discussion-module--alpha--2wwoE:before{content:"η: «"}.Discussion-module--alpha--2wwoE:after,.Discussion-module--beta--280lX:after{content:"»"}.Discussion-module--beta--280lX:before{content:"μ: «"}.articleTemplate-module--header--354F0{display:grid;grid-template-rows:auto auto;grid-template-columns:auto auto;column-gap:.25rem;font-size:1.2rem;margin-bottom:2rem}.articleTemplate-module--date--2zr35{grid-column:2;grid-row:1;justify-self:end}.articleTemplate-module--h1--2QcXm{grid-row:1;grid-column:1;margin:0}.articleTemplate-module--tags--1YeyG{grid-row:2;grid-column:1/span 2}.PreviousAndNext-module--navigation--123UK{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,auto);border:1px solid var(--linkColor);border-radius:5px}.PreviousAndNext-module--link--iq7Ea{display:flex;align-items:center;justify-content:center;padding:.25rem 1.5rem;background-color:var(--linkColor);color:var(--linkColorMainContrast);text-decoration:none;align-self:stretch;margin:.25rem;border-radius:5px}.PreviousAndNext-module--linkPrevious--2WFha{grid-column:1;grid-row:1}.PreviousAndNext-module--linkNext--3jMS3{grid-column:2;grid-row:1}.PreviousAndNext-module--disabled--oYrWw{opacity:.2}.PreviousAndNext-module--link--iq7Ea:hover{text-shadow:var(--linkHoverHighlight)}.PreviousAndNext-module--title--3-yUO{font-size:1rem;padding:0 .5rem}.PreviousAndNext-module--border--dT-B7{border-left:1px dashed var(--linkColor)}@media (min-width:768px){.PreviousAndNext-module--navigation--123UK{grid-template-columns:auto repeat(2,1fr) auto;grid-template-rows:auto}.PreviousAndNext-module--link--iq7Ea{margin:0;border-radius:0}.PreviousAndNext-module--linkPrevious--2WFha{grid-column:1}.PreviousAndNext-module--linkNext--3jMS3{grid-column:4}.PreviousAndNext-module--border--dT-B7{border-left:1px solid var(--linkColor)}}.tagTemplate-module--articleList--1XmWn{font-size:1.2rem;list-style:circle inside}.tagTemplate-module--articleList--1XmWn a,.tagTemplate-module--articleListHeader--3yVYd a{text-decoration:none}.tagTemplate-module--articleList--1XmWn a:hover,.tagTemplate-module--articleListHeader--3yVYd a:hover{text-decoration:underline}</style><meta name="generator" content="Gatsby 3.4.2"/><title data-react-helmet="true">Do you think your Windows.Forms Application has no memory leaks?</title><link data-react-helmet="true" rel="preconnect" href="https://fonts.gstatic.com"/><link data-react-helmet="true" href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet"/><link data-react-helmet="true" href="//fonts.googleapis.com/css2?family=Lora:ital,wght@1,500&amp;display=swap" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="Content from Frank Quednau about dev and fields of interest."/><meta data-react-helmet="true" name="keywords" content="software-development, dotnet, windows, csharp"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Do you think your Windows.Forms Application has no memory leaks?"/><meta data-react-helmet="true" name="twitter:site:id" content="fquednau"/><meta data-react-helmet="true" name="twitter:description" content="If your answer is yes, please read on, because,  once , I thought so, too. Let me first clarify what I mean by leaks in a .NET application. Under this…"/><meta data-react-helmet="true" name="twitter:image" content="/icons/icon-72x72.png"/><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" title="Realfiction RSS" href="/atom.xml"/><link rel="icon" href="/favicon-32x32.png?v=4ebdacb62247bfbfe92c555d6c833c53" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4ebdacb62247bfbfe92c555d6c833c53"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link as="script" rel="preload" href="/webpack-runtime-10fde4d716fb505c2984.js"/><link as="script" rel="preload" href="/framework-75034fa8e3a9e81ff051.js"/><link as="script" rel="preload" href="/app-4efc4d6aa7df27a3a823.js"/><link as="script" rel="preload" href="/commons-5ffe1f2bcdc9b9fa2a3d.js"/><link as="script" rel="preload" href="/component---src-templates-article-template-js-269013ae4575902adbfb.js"/><link as="fetch" rel="preload" href="/page-data/2010/05/26/do-you-think-your-windows-forms-application-has-no-memory-leaks/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/256249292.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2581731408.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="layout-module--layout--3NElS"><nav class="SiteHeader-module--siteNav--3VakG"><div class="SiteHeader-module--main--uZpGc"><h1 class="SiteHeader-module--siteHeader--3gDoz"><a class="SiteHeader-module--mainLink---Exlm" href="/">Realfiction</a></h1><div><a class="SiteHeader-module--siteLink--1QNau" href="/tags">Tags</a><a class="SiteHeader-module--siteLink--1QNau" href="/about">About</a></div></div></nav><main class="layout-module--main--1XJsu"><article><header class="articleTemplate-module--header--354F0"><time class="DateDisplay-module--dateContainer--1trkw articleTemplate-module--date--2zr35" dateTime="2010-05-26"><span class="DateDisplay-module--month--2KOka">May</span><span class="DateDisplay-module--date--oZxQz">26</span><span class="DateDisplay-module--year--2577t">2010</span></time><h1 class="articleTemplate-module--h1--2QcXm">Do you think your Windows.Forms Application has no memory leaks?</h1><nav class="Tag-module--tags--3UNk1 articleTemplate-module--tags--1YeyG"><div class="Tag-module--tagOuter--27OmX"><a class="Tag-module--tag--3otWA" href="/tags/software-development">software-development</a></div><div class="Tag-module--tagOuter--27OmX"><a class="Tag-module--tag--3otWA" href="/tags/dotnet">dotnet</a></div><div class="Tag-module--tagOuter--27OmX"><a class="Tag-module--tag--3otWA" href="/tags/windows">windows</a></div><div class="Tag-module--tagOuter--27OmX"><a class="Tag-module--tag--3otWA" href="/tags/csharp">csharp</a></div></nav></header><p>If your answer is yes, please read on, because, <em>once</em>, I thought so, too.</p><p>Let me first clarify what I mean by leaks in a .NET application. Under this definition you may have a leak when an instance persists in memory even though you expect it to be collected by the Garbage collector. A typical usage of your App on your local desktop may not expose any issues since local memory can be quite sufficient and some problems may only occur because of certain usage patterns. In other environments like e.g., a <a href="http://www.citrix.com/lang/English/home.asp">Citrix Desktop</a>, where the app runs in a much more constrained environment, problems may become apparent far quicker. </p><p>In a windows forms application memory pressure is even higher, because Windows Forms, as it turns out, is a thin layer of .NET on top of a multi-decade old technology, <a href="http://en.wikipedia.org/wiki/Graphics_Device_Interface">GDI</a>. The great <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx">Process Explorer</a> allows you to look at the GDI Objects consumed by any process by turning on the respective column:</p><p> <img src="/assets/gdiObjects_6ffad6a0-8d1a-496a-93b8-ddf5f53cc21a.png" alt="gdiObjects" title="gdiObjects"/> </p><p>The resource of GDI objects is quite limited, as it may not surpass a number defined in the registry as <strong>GDIProcessHandleQuota</strong>. The default is 10’000. You may increase that number, but as you can see you may run out of GDI Object handles long before your memory is exhausted.</p><p><img src="/assets/handleQuota_5cab2b59-cbb5-4178-8868-0c5082df4bd0.png" alt="handleQuota" title="handleQuota"/> </p><p>How can this be? .NET has a Garbage Collector (GC), or has it? Indeed, none of the issues arise because the GC is broken. It is not. The biggest source of loosing objects is by <strong>attaching event handlers to events of objects that live longer than the instances to which the event handlers belong</strong>. Add to this the failure to <strong>correctly Dispose of Objects in the System.Windows.Forms namespace</strong>. Let’s check out some real life examples.</p><p>The single most useful tool to approach possible issues with memory is a memory profiler. There are several on the market but since I am a sucker for Jetbrains products my choice fell on the <a href="http://www.jetbrains.com/profiler/features/index.html">dotTrace</a> product.</p><h3>1. Bad Icon, bad</h3><p>The most hefty GDI object leak was related to…icons. The following code is <em>reeally baad</em>:</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp">changeProvider<span class="token punctuation">.</span>Icon <span class="token operator">=</span> 
 Icon<span class="token punctuation">.</span><span class="token function">FromHandle</span><span class="token punctuation">(</span>Resources<span class="token punctuation">.</span>data_edit<span class="token punctuation">.</span><span class="token function">GetHicon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><p>I really don’t know enough about this sort of resource creation but after some strange behaviour regarding errors, the code was modified to the following (as outlined in the <a href="http://msdn.microsoft.com/en-us/library/system.drawing.bitmap.gethicon.aspx">documentation to GetHicon()</a>):</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;user32&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">DestroyIcon</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Icon</span> <span class="token function">RetrieveEditIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name"><span class="token keyword">var</span></span> hIcon <span class="token operator">=</span> Resources<span class="token punctuation">.</span>data_edit<span class="token punctuation">.</span><span class="token function">GetHicon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token keyword">var</span></span> temp <span class="token operator">=</span> Icon<span class="token punctuation">.</span><span class="token function">FromHandle</span><span class="token punctuation">(</span>hIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token keyword">var</span></span> ico <span class="token operator">=</span> <span class="token punctuation">(</span>Icon<span class="token punctuation">)</span>temp<span class="token punctuation">.</span><span class="token function">Clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  temp<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">DestroyIcon</span><span class="token punctuation">(</span>hIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ico<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><h3>2. The GC-Alloc’d Timer</h3><p>You may or may not have the same opinion about Windows.Forms Binding but in my eyes it is an absolute beast. We are using a concept of Control connectors that abstract the behaviour of controls for our system. In there a timer is used that gets its say after a short period of the user typing in stuff in a textbox. That way we get a binding that is more logical to the user than the Focus Lost behaviour and is less intrusive than the SourceChanged Binding. To my dismay, something weird was happening to the TimerCallback, the Event handler delegate that represents a callback from the timer:</p><p><img src="/assets/timerLeak_6e94ad39-e5bd-4722-8a31-7ec4b782389c.png" alt="timerLeak" title="timerLeak"/> </p><p>A Garbage Collector Handle was keeping my Timer callback to go away. Since it was connected to a connector which in turn exposes events to other parts of some application module, all kind of objects are now stuck in memory, objects that due to their affinity to Windows Forms may also leak GDI objects.</p><p>Such handles can be constructed with the <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.gchandle_members(v=VS.100).aspx">GCHandle</a> struct. they allow you to pin objects to memory, avoiding that they be reclaimed by the Garbage Collector. I haven’t quite understood the behaviour to date, as the documentation of the <a href="http://msdn.microsoft.com/en-us/library/system.threading.timer.aspx">Timer</a> says nothing about such behaviour. On the contrary, it puts the responsibility to the Timer’s user to ensure that a timer does not go out of scope.</p><p>The basic solution is to ensure explicit disposal of a timer, in our case by listening to the connected control’s Disposed-event. Alas, in some circumstances it appears that the Control’s Dispose was not called, leaving us still with objects dangling off the timer. The final end to this problem was to make the connection between Timer and event handler <em>weaker</em>.</p><div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">Timer</span> changeDelayTimer<span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>
changeDelayTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Timer</span><span class="token punctuation">(</span>onChangeDelayCallback<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeakReference</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">onChangeDelayCallback</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> state<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name"><span class="token keyword">var</span></span> wr <span class="token operator">=</span> <span class="token punctuation">(</span>WeakReference<span class="token punctuation">)</span> state<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>wr<span class="token punctuation">.</span>IsAlive<span class="token punctuation">)</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span>TextBoxConnector<span class="token punctuation">)</span>wr<span class="token punctuation">.</span>Target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HandleTimerSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div><p>The timer now references a static handler, and just to be sure, the actual object is only accessible through a WeakReference object. Such a thing allows a targetted object to be collected by the GC. There may still be a minor headache in case that the GC collects the object between the if-statement and the access in the next line, but at least we got rid of the object trees dangling off the timer.</p><h3>3. The 3rd party static event</h3><p>Imagine you use some component and suddenly you realize that said component attaches to a static event handler, i.e. a part of the system that remains alive until the end of the AppDomain. This is what happens to you when you do not explicitly dispose certain components from <a href="http://www.infragistics.com/">Infragistics</a>:</p><p><img src="/assets/gridLeak_534c2e57-c6a5-447c-8714-6245a2af9029.png" alt="gridLeak" title="gridLeak"/></p><p>Infragistics was already made aware of this kind of behaviour quite some time ago as shown in this <a href="http://forums.infragistics.com/forums/t/20841.aspx">discussion thread</a>. As they say that this behaviour is by design and just make sure that all Controls get properly disposed, things remained like that up to the version that we are utilizing for the project. The solution to that one is either dispose of all controls, or use the somewhat dirty but effective move to empty the invocation list of the relevant static events. This is indeed possible through reflection and funny enough the required code had already been written and <a href="http://subjectively.blogspot.com/2009/03/importance-of-recycling-memory.html">is available on the Internet</a>. Since we don’t use any of the theme changing capabilities of Ig controls, this code is called at an appropriate moment and it ensures that no component leak happens through that chain anymore.</p><h3>4. Undisposed Tooltips</h3><p>Funny enough in the first snapshots I didn’t find much trace of undisposed tooltips but this was the case now in the latest snapshots that I was doing with dotTrace. One would think that issues as can be found with the <a href="http://www.google.de/search?ie=UTF-8&amp;q=windows+forms+tooltip+gdi+object+leak">proper google search</a> are not relevant anymore, but there you go…Tooltips really aren’t that heavy objects, but their missing removal was a direct leak of GDI objects as I could notice upon ensuring proper disposal of them. Since we are using tooltips on a certain kind of label, the correct move was to move the tooltip creation into a class inheriting from label and using the base Control’s disposing event.</p><p>I hope that if you still answer the title question with yes, it is based on a couple of memory profiling sessions and the awareness of the ways .NET and GDI object leaks may come into live.</p></article><nav class="PreviousAndNext-module--navigation--123UK"><a class="PreviousAndNext-module--linkPrevious--2WFha PreviousAndNext-module--link--iq7Ea" aria-describedby="previousTitle" href="/2010/05/22/assimilose">&lt;</a><span id="previousTitle" class="PreviousAndNext-module--title--3-yUO">Assimilose</span><span id="nextTitle" class="PreviousAndNext-module--title--3-yUO PreviousAndNext-module--border--dT-B7">respond_to in .NET</span><a class="PreviousAndNext-module--linkNext--3jMS3 PreviousAndNext-module--link--iq7Ea" aria-describedby="nextTitle" href="/2010/07/16/respond_to-in-net">&gt;</a></nav></main><footer class="Footer-module--main--1QC0I"><a rel="license noopener noreferrer" target="_new" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png"/></a><p>Frank Quednau <!-- -->2021</p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  window.excludeGAPaths=[/^(?:\/404)$/];
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-1812710-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2010/05/26/do-you-think-your-windows-forms-application-has-no-memory-leaks";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-72b219bae196683411be.js"],"app":["/app-4efc4d6aa7df27a3a823.js"],"component---src-pages-404-js":["/component---src-pages-404-js-65e0e6024a51ef90147e.js"],"component---src-pages-about-js":["/component---src-pages-about-js-938610e8d1e33912361f.js"],"component---src-pages-index-js":["/component---src-pages-index-js-af6f54d0700b918d2163.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-289c177ccd69332b3e3d.js"],"component---src-templates-article-template-js":["/component---src-templates-article-template-js-269013ae4575902adbfb.js"],"component---src-templates-tag-template-js":["/component---src-templates-tag-template-js-1d9c79df7cff12c7ff91.js"]};/*]]>*/</script><script src="/polyfill-72b219bae196683411be.js" nomodule=""></script><script src="/component---src-templates-article-template-js-269013ae4575902adbfb.js" async=""></script><script src="/commons-5ffe1f2bcdc9b9fa2a3d.js" async=""></script><script src="/app-4efc4d6aa7df27a3a823.js" async=""></script><script src="/framework-75034fa8e3a9e81ff051.js" async=""></script><script src="/webpack-runtime-10fde4d716fb505c2984.js" async=""></script></body></html>